<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Distribution Tool (DRIP System - G - v16.2)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset and Font */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; background-color: #f1f5f9; padding: 20px; }

        /* Main Container */
        .main-container { max-width: 1440px; margin: 20px auto; background: linear-gradient(to bottom, white, #f8fafc); padding: 24px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; }

        /* Headings and Text */
        h1 { font-size: 1.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; text-align: center; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb; }
        .subtitle { font-size: 1rem; color: #475569; margin-bottom: 1rem; text-align: center; }

        /* Improved Time Selection */
        .time-selection { text-align: center; margin-bottom: 2rem; padding: 10px; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; justify-content: center; align-items: center; gap: 15px; }
        .time-selection strong { color: #1e293b; font-weight: 600; }
        .time-selection label { display: inline-flex; align-items: center; padding: 8px 15px; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; background-color: white; font-weight: 500; color: #334155; margin: 0; }
        .time-selection input[type="radio"] { display: none; }
        .time-selection input[type="radio"]:checked + label { background-color: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; font-weight: 600; }
        .time-selection label:hover { background-color: #f0f9ff; border-color: #7dd3fc; }

        /* Content Layout (Grid for Input Sections) */
        .input-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 2rem; }

        /* Service Section Styling */
        fieldset.service-section { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); background-color: white; margin-bottom: 1rem; }
        fieldset.ri-section { border-color: #1d4ed8; background-color: #eff6ff; }
        fieldset.ri-section legend { color: #1d4ed8; }
        fieldset.icu-section { border-color: #7c3aed; background-color: #f5f3ff; }
        fieldset.icu-section legend { color: #7c3aed; }
        legend { font-size: 1.125rem; font-weight: 600; color: #1e293b; padding: 0 8px; margin-left: -8px; margin-bottom: 15px; }

        /* Team Member / Input Group Styling */
        .team-member { border: 1px solid #e5e7eb; padding: 10px; margin-bottom: 10px; border-radius: 6px; background-color: #f9fafb; }
        .on-call-section { border: 1px dashed #94a3b8; padding: 10px; margin-bottom: 10px; border-radius: 6px; background-color: #f8fafc; }
        .on-call-section label { font-weight: 600; color: #0f766e; }

        /* Labels & Inputs */
        label { display: block; font-size: 0.875rem; font-weight: 500; color: #334155; margin-bottom: 4px; }
        input[type="text"], input[type="number"] { margin-top: 4px; display: block; width: 100%; border-radius: 6px; border: 1px solid #cbd5e1; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); padding: 8px 10px; background-color: white; color: #0f172a; font-size: 0.875rem; margin-bottom: 8px; }
        input[type="number"] { width: 70px; display: inline-block; margin-right: 8px; }
        input:focus { border-color: #3b82f6; outline: 1px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

        /* Cap Info Styling */
        .cap-info { font-size: 0.75rem; color: #64748b; display: block; margin-top: 2px; line-height: 1.3; }
        .cap-increase-note { font-size: 0.8rem; color: #be123c; font-weight: 500; margin-bottom: 1rem; padding: 6px; background-color: #ffe4e6; border: 1px solid #fda4af; border-radius: 4px; line-height: 1.4; }

        /* --- Status Board Visualization --- */
        #status-board { margin-top: 1rem; padding: 1.5rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; }
        #status-board h2 { text-align: center; margin-bottom: 1.5rem; color: #334155; font-size: 1.25rem; font-weight: 600; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        .status-person { background-color: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .status-person.active-on-call { border-color: #f59e0b; border-width: 2px; box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
        .status-person-name { font-weight: 600; color: #1e293b; margin-bottom: 8px; font-size: 0.85rem; display: block; min-height: 2.2em; line-height: 1.3; }
        .status-person-name .role-tag { font-size: 0.65rem; font-weight: 500; padding: 2px 5px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        .role-gm { background-color: #dbeafe; color: #1e40af; }
        .role-tele { background-color: #d1fae5; color: #065f46; }
        .role-ri { background-color: #e0e7ff; color: #3730a3; }
        .role-flex { background-color: #fef3c7; color: #92400e; }
        .role-oncall { background-color: #fee2e2; color: #991b1b; }
        .role-postcall { background-color: #f3e8ff; color: #6b21a8; }
        .role-icu { background-color: #ede9fe; color: #5b21b6; }
        .slots-container { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px; min-height: 22px; }
        .slot { width: 16px; height: 16px; border-radius: 3px; border: 1px solid #cbd5e1; background-color: #f1f5f9; position: relative; display: flex; align-items: center; justify-content: center; }
        .slot.filled { background-color: #64748b; border-color: #475569; }

        /* --- Highlight Styles --- */
        .slot.next-admission-gm,
        .slot.next-admission-tele,
        .slot.next-admission-flex { border-width: 2px; box-shadow: 0 0 4px rgba(0,0,0, 0.2); transform: scale(1.15); z-index: 1; }
        .slot.next-admission-gm { background-color: #93c5fd; border-color: #3b82f6; }
        .slot.next-admission-gm::after { color: #1e40af; }
        .slot.next-admission-tele { background-color: #a7f3d0; border-color: #10b981; }
        .slot.next-admission-tele::after { color: #065f46; }
        .slot.next-admission-flex { background-color: #fde047; border-color: #eab308; }
        .slot.next-admission-flex::after { color: #854d0e; }
         .slot.next-admission-gm::after,
         .slot.next-admission-tele::after,
         .slot.next-admission-flex::after { content: attr(data-next-index); position: absolute; font-size: 0.6rem; font-weight: bold; line-height: 1; }

        .slot.increase-9, .slot.increase-10 { background-color: #fecaca; border: 1px dashed #ef4444; opacity: 0.8; }
        .slot.increase-9.filled, .slot.increase-10.filled { background-color: #dc2626; border-color: #b91c1c; opacity: 1; }
        .slot.increase-9.next-admission-gm, .slot.increase-10.next-admission-gm { background-color: #93c5fd; border-color: #3b82f6; opacity: 1; }
        .slot.increase-9.next-admission-tele, .slot.increase-10.next-admission-tele { background-color: #a7f3d0; border-color: #10b981; opacity: 1; }
        .slot.increase-9.next-admission-flex, .slot.increase-10.next-admission-flex { background-color: #fde047; border-color: #eab308; opacity: 1; }

        .status-person-count { font-size: 0.75rem; color: #475569; text-align: right; }
        .status-person-capped { font-weight: bold; color: #dc2626; }
         #status-message { text-align: center; margin-top: 1rem; font-weight: bold; color: #991b1b; min-height: 1.5em; }

         /* --- Results List --- */
         #results-list { margin-top: 2rem; padding: 1.5rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; }
         .results-columns { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: space-around; }
         .results-column h3 { font-size: 1.1rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.75rem; border-bottom: 1px solid #bfdbfe; padding-bottom: 0.25rem; }
         .results-column ol { list-style-type: decimal; padding-left: 1.5rem; font-size: 0.9rem; }
         .results-column li { margin-bottom: 0.4rem; color: #1e40af; }
         .results-column li strong { color: #1e3a8a; }
         .results-column .team-label { font-size: 0.8em; color: #475569; margin-left: 4px; }
         .results-column .cap-detail { font-size: 0.75rem; font-style: italic; color: #64748b; margin-left: 5px; }
         .results-column .no-results { font-style: italic; color: #64748b; }

        /* Button Container */
        .button-container { margin-top: 2rem; padding: 1rem; background-color: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }

        /* Buttons */
        button { padding: 10px 18px; font-size: 0.875rem; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); line-height: 1.5; margin-top: 5px; }
        button:focus { outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.5); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-secondary:focus { box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.5); }
         .btn-highlight-all { background-color: #10b981; color: white; }
         .btn-highlight-all:hover { background-color: #059669; }
         .btn-highlight-all:focus { box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5); }

        /* Notes Area Styling */
        .notes { margin-top: 2.5rem; font-size: 0.875rem; color: #475569; border-top: 1px solid #e2e8f0; padding-top: 1rem; background-color: #f8fafc; padding: 1rem; border-radius: 8px; grid-column: 1 / -1; }
        .notes h3 { font-size: 1rem; font-weight: 600; color: #334155; margin-bottom: 0.75rem; }
        .notes ul { list-style-position: outside; list-style-type: disc; margin-top: 0.5rem; padding-left: 1.5rem; }
        .notes ul ul { margin-left: 1.25rem; margin-top: 0.25rem; list-style-type: circle; }
        .notes li { margin-bottom: 0.5rem; }
        .notes strong { font-weight: 600; color: #1e293b; }
        .notes em { font-style: italic; color: #0f766e; }

        /* Responsive Adjustments */
        @media (min-width: 768px) { body { padding: 30px; } .main-container { padding: 32px; } }

    </style>
</head>
<body>

    <div class="main-container">
        <h1>Admission Distribution Tool</h1>
        <p class="subtitle">DRIP System - G (Valid: 2 Flex Res + 2 RI Res) - Status Board</p>

        <div class="time-selection">
            <strong>Current Time:</strong>
            <input type="radio" id="time-before-1pm" name="time-context" value="before" checked onchange="handleTimeChange()">
            <label for="time-before-1pm">Before 1 PM</label>
            <input type="radio" id="time-after-1pm" name="time-context" value="after" onchange="handleTimeChange()">
            <label for="time-after-1pm">1 PM or Later</label>
        </div>

        <div class="input-wrapper">
             <fieldset class="service-section">
                <legend>General Medicine (GM)</legend>
                <p class="cap-increase-note">Cap increase to 9/10 only occurs after ALL GM drip members (including primary) reach base cap.</p>
                <div class="on-call-section">
                    <label for="name-gm-oncall">GM On-Call Intern Name:</label>
                    <input type="text" id="name-gm-oncall" placeholder="Enter name" oninput="updateStatusBoard()">
                    <label for="count-gm-oncall">Current Count:</label>
                    <input type="number" id="count-gm-oncall" value="0" min="0" max="15" oninput="updateStatusBoard()">
                    <span class="cap-info">(Cap: 8, Increases to 9-10) - Takes admissions first <strong style='color:#0f766e;'>after 1 PM</strong> until capped.</span>
                </div>
                 <div class="team-member">
                    <label for="name-gm-postcall">GM Post Call Intern Name:</label>
                    <input type="text" id="name-gm-postcall" placeholder="Optional Name" oninput="updateStatusBoard()">
                    <label for="count-gm-postcall">Current Count:</label>
                    <input type="number" id="count-gm-postcall" value="0" min="0" max="15" oninput="updateStatusBoard()">
                    <span class="cap-info">(Cap: 8, Increases to 9-10) - Takes admissions first <strong style='color:#0f766e;'>before 1 PM</strong> until capped.</span>
                </div>
                <div class="team-member">
                    <label for="name-gm-prepre">GM Pre-Pre Call Intern Name:</label>
                    <input type="text" id="name-gm-prepre" placeholder="Optional Name" oninput="updateStatusBoard()">
                    <label for="count-gm-prepre">Current Count:</label>
                    <input type="number" id="count-gm-prepre" value="0" min="0" max="15" oninput="updateStatusBoard()">
                    <span class="cap-info">(Cap: 8, Increases to 9-10)</span>
                </div>
                <div class="team-member">
                    <label for="name-gm-precall">GM Pre-Call Intern Name:</label>
                    <input type="text" id="name-gm-precall" placeholder="Optional Name" oninput="updateStatusBoard()">
                    <label for="count-gm-precall">Current Count:</label>
                    <input type="number" id="count-gm-precall" value="0" min="0" max="15" oninput="updateStatusBoard()">
                    <span class="cap-info">(Cap: 8, Increases to 9-10)</span>
                </div>
                <button onclick="highlightNextAdmissionSequence('gm')" class="btn-primary" style="width:100%; margin-top: 10px;">Highlight Next 10 GM Admissions</button>
            </fieldset>

            <fieldset class="service-section">
                <legend>Telemetry (Tele)</legend>
                 <p class="cap-increase-note">Cap increase to 9/10 only occurs after ALL Tele drip members (including primary) reach base cap.</p>
                 <div class="on-call-section">
                     <label for="name-tele-oncall">Tele On-Call Intern Name:</label>
                     <input type="text" id="name-tele-oncall" placeholder="Enter name" oninput="updateStatusBoard()">
                     <label for="count-tele-oncall">Current Count:</label>
                     <input type="number" id="count-tele-oncall" value="0" min="0" max="15" oninput="updateStatusBoard()">
                     <span class="cap-info">(Cap: 8, Increases to 9-10) - Takes admissions first <strong style='color:#0f766e;'>after 1 PM</strong> until capped.</span>
                 </div>
                 <div class="team-member">
                    <label for="name-tele-postcall">Tele Post Call Intern Name:</label>
                    <input type="text" id="name-tele-postcall" placeholder="Optional Name" oninput="updateStatusBoard()">
                    <label for="count-tele-postcall">Current Count:</label>
                    <input type="number" id="count-tele-postcall" value="0" min="0" max="15" oninput="updateStatusBoard()">
                     <span class="cap-info">(Cap: 8) - Takes admissions first <strong style='color:#0f766e;'>before 1 PM</strong> until capped.</span>
                 </div>
                 <div class="team-member">
                    <label for="name-nct">NCT Resident Name:</label>
                    <input type="text" id="name-nct" placeholder="Optional Name" oninput="updateStatusBoard()">
                    <label for="count-nct">Current Count:</label>
                    <input type="number" id="count-nct" value="0" min="0" max="10" oninput="updateStatusBoard()">
                    <span class="cap-info">(Cap: 3)</span>
                </div>
                 <div class="team-member">
                    <label for="name-tele-precall">Tele Pre-call Intern Name:</label>
                    <input type="text" id="name-tele-precall" placeholder="Optional Name" oninput="updateStatusBoard()">
                    <label for="count-tele-precall">Current Count:</label>
                    <input type="number" id="count-tele-precall" value="0" min="0" max="15" oninput="updateStatusBoard()">
                     <span class="cap-info">(Cap: 8)</span>
                 </div>
                <button onclick="highlightNextAdmissionSequence('tele')" class="btn-primary" style="width:100%; margin-top: 10px;">Highlight Next 10 Tele Admissions</button>
            </fieldset>

             <fieldset class="service-section ri-section">
                <legend>RI Residents (Shared)</legend>
                <div class="team-member">
                    <label for="name-ri-a">RI Res A Name:</label>
                    <input type="text" id="name-ri-a" placeholder="Resident Name" oninput="updateStatusBoard()">
                    <label for="count-ri-a">Total Count (GM + Tele):</label>
                    <input type="number" id="count-ri-a" value="0" min="0" max="15" oninput="updateStatusBoard()">
                    <span class="cap-info">(Total Cap: 8, Increases to 9-10 based on service need)</span>
                </div>
                 <div class="team-member">
                    <label for="name-ri-b">RI Res B Name:</label>
                    <input type="text" id="name-ri-b" placeholder="Resident Name" oninput="updateStatusBoard()">
                    <label for="count-ri-b">Total Count (GM + Tele):</label>
                    <input type="number" id="count-ri-b" value="0" min="0" max="15" oninput="updateStatusBoard()">
                    <span class="cap-info">(Total Cap: 8, Increases to 9-10 based on service need)</span>
               </div>
            </fieldset>

            <fieldset class="service-section">
                <legend>Flex / Observation Team</legend>
                <div class="team-member">
                    <label for="name-flex-res-1">Flex Resident 1 Name:</label>
                    <input type="text" id="name-flex-res-1" placeholder="e.g., Flex Res Alpha" oninput="updateStatusBoard()">
                    <label for="count-flex-res-1">Current Count:</label>
                    <input type="number" id="count-flex-res-1" value="0" min="0" max="10" oninput="updateStatusBoard()">
                    <span class="cap-info">(Cap: 8. OBS Pts ONLY)</span>
                 </div>
                 <div class="team-member">
                    <label for="name-flex-res-2">Flex Resident 2 Name:</label>
                    <input type="text" id="name-flex-res-2" placeholder="e.g., Flex Res Bravo" oninput="updateStatusBoard()">
                    <label for="count-flex-res-2">Current Count:</label>
                    <input type="number" id="count-flex-res-2" value="0" min="0" max="10" oninput="updateStatusBoard()">
                    <span class="cap-info">(Cap: 8. OBS Pts ONLY)</span>
                </div>
                 <button onclick="highlightNextFlexAdmission()" class="btn-primary" style="width:100%;">Highlight Next Flex Admission</button>
            </fieldset>

             <fieldset class="service-section icu-section">
                 <legend>ICU (Display Only)</legend>
                 <div class="team-member">
                     <label for="name-icu-intern-1">ICU Intern 1 Name:</label>
                     <input type="text" id="name-icu-intern-1" placeholder="ICU Intern Alpha" oninput="updateStatusBoard()">
                     <label for="count-icu-intern-1">Current Count:</label>
                     <input type="number" id="count-icu-intern-1" value="0" min="0" max="10" oninput="updateStatusBoard()">
                     <span class="cap-info">(Cap: Not Applicable)</span>
                  </div>
                  <div class="team-member">
                     <label for="name-icu-intern-2">ICU Intern 2 Name:</label>
                     <input type="text" id="name-icu-intern-2" placeholder="ICU Intern Bravo" oninput="updateStatusBoard()">
                     <label for="count-icu-intern-2">Current Count:</label>
                     <input type="number" id="count-icu-intern-2" value="0" min="0" max="10" oninput="updateStatusBoard()">
                     <span class="cap-info">(Cap: Not Applicable)</span>
                 </div>
             </fieldset>

        </div>

        <div id="status-board">
            <h2>Current Status & Next Admission(s)</h2>
            <div id="status-grid" class="status-grid">
                </div>
           <div id="status-message" style="text-align: center; margin-top: 1rem; font-weight: bold; color: #991b1b;">
               </div>
        </div>

        <div id="results-list" style="display: none;"> <div class="results-columns">
                 <div class="results-column" id="gm-results-col">
                     <h3>Next 10 GM Admissions</h3>
                     <ol id="gm-results-list"></ol>
                 </div>
                 <div class="results-column" id="tele-results-col">
                     <h3>Next 10 Tele Admissions</h3>
                     <ol id="tele-results-list"></ol>
                 </div>
             </div>
        </div>


         <div class="button-container">
             <button onclick="highlightAllServices()" class="btn-highlight-all">Highlight All & Show Lists</button>
             <button onclick="resetCounts()" class="btn-secondary">Reset All Counts & Names</button>
         </div>

        <div class="notes">
             <h3>System Notes:</h3>
             <ul>
                 <li><strong>Highlight Next 10:</strong> GM/Tele buttons highlight the slots for the next 10 potential admissions on the Status Board and display the list below.</li>
                  <li><strong>Highlight All:</strong> Shows highlights for GM, Tele, and Flex on the Status Board and displays the GM/Tele lists below.</li>
                 <li><strong>Time Context:</strong> Select "Before 1 PM" or "1 PM or Later" to determine the admission sequence.</li>
                 <li><strong>Primary Recipient:</strong> Before 1 PM, the Post-Call intern takes admissions first until capped (8). After 1 PM, the On-Call intern takes first until capped (8). The active On-Call intern's box on the status board is highlighted with an amber border.</li>
                 <li><strong>Drip Sequence (Round-Robin):</strong> After the primary recipient is capped, subsequent admissions cycle through the remaining eligible team members (RI Res, Pre-Pre, Pre-Call, NCT) one by one. The tool finds the *next* person in the cycle who is below their base cap.</li>
                 <li><strong>Cap Increase Timing:</strong> Increases to 9/10 only occur after the primary recipient AND *all* members of the standard drip sequence for that specific service have reached their base caps. The increase is then applied round-robin to eligible members *within that service*.</li>
                 <li><strong>On-Call Interns:</strong> Have counts/caps (8). Only receive drip admissions after 1 PM (filling first). Both GM and Tele On-Call *are* eligible for cap increase to 9/10 (after all respective drip members are capped at base).</li>
                 <li><strong>RI Residents (Combined Counts):</strong> Have a single total count. Base cap 8. Participate in cap increase to 9/10 based on service need (eligibility determined by the service triggering the increase).</li>
                <li><strong>Gowda Patients:</strong> Distributed equally within the drip system (follow the standard drip).</li>
                <li><strong>Weekend Distribution:</strong> Manual 'keep' logic applies (see PDF/local guidelines). This tool calculates the sequence based on time/caps.</li>
                <li><strong>Flex/OBS Team:</strong> Two residents, each capped at 8 OBS patients. Next admission goes to the resident with the lower count.</li>
                <li><strong>ICU:</strong> Displayed for status awareness only; not part of any admission drip logic in this tool.</li>
                 <li><strong>Cap Increase Eligibility:</strong>
                    <ul>
                        <li>GM: Applies to Post-Call, Pre-Pre, Pre-Call, RI Res A, RI Res B, On-Call.</li>
                        <li>Tele: Applies *only* to RI Res A, RI Res B, On-Call. (NCT, Post-Call, Pre-call are excluded from increase).</li>
                    </ul>
                 </li>
             </ul>
        </div>

    </div>

    <script>
        // Define team structure and base parameters
        const teams = {
            'gm_postcall': { nameId: 'name-gm-postcall', countId: 'count-gm-postcall', cap: 8, label: 'GM Post Call Intern', increasesCap: true, role: 'Post-Call', service: 'gm' },
            'ri_a': { nameId: 'name-ri-a', countId: 'count-ri-a', cap: 8, label: 'RI Res A', increasesCap: true, role: 'RI Res', service: 'shared' },
            'gm_prepre': { nameId: 'name-gm-prepre', countId: 'count-gm-prepre', cap: 8, label: 'GM Pre-Pre Call Intern', increasesCap: true, role: 'Intern', service: 'gm' },
            'gm_precall': { nameId: 'name-gm-precall', countId: 'count-gm-precall', cap: 8, label: 'GM Pre-Call Intern', increasesCap: true, role: 'Intern', service: 'gm' },
            'ri_b': { nameId: 'name-ri-b', countId: 'count-ri-b', cap: 8, label: 'RI Res B', increasesCap: true, role: 'RI Res', service: 'shared' },
            'gm_oncall': { nameId: 'name-gm-oncall', countId: 'count-gm-oncall', cap: 8, label: 'GM On-Call Intern', increasesCap: true, role: 'On-Call', service: 'gm'}, // GM On-Call IS eligible
            'tele_postcall': { nameId: 'name-tele-postcall', countId: 'count-tele-postcall', cap: 8, label: 'Tele Post Call Intern', increasesCap: false, role: 'Post-Call', service: 'tele' }, // Tele Post-Call NOT eligible for increase
            'nct': { nameId: 'name-nct', countId: 'count-nct', cap: 3, label: 'NCT Resident', increasesCap: false, role: 'NCT Res', service: 'tele' }, // NCT NOT eligible
            'tele_precall': { nameId: 'name-tele-precall', countId: 'count-tele-precall', cap: 8, label: 'Tele Pre-call Intern', increasesCap: false, role: 'Intern', service: 'tele' }, // Tele Pre-Call NOT eligible for increase
            'tele_oncall': { nameId: 'name-tele-oncall', countId: 'count-tele-oncall', cap: 8, label: 'Tele On-Call Intern', increasesCap: true, role: 'On-Call', service: 'tele'}, // Tele On-Call IS eligible
            'flex_res_1': { nameId: 'name-flex-res-1', countId: 'count-flex-res-1', cap: 8, label: 'Flex Resident 1', increasesCap: false, role: 'Flex Res', service: 'flex' },
            'flex_res_2': { nameId: 'name-flex-res-2', countId: 'count-flex-res-2', cap: 8, label: 'Flex Resident 2', increasesCap: false, role: 'Flex Res', service: 'flex' },
            'icu_intern_1': { nameId: 'name-icu-intern-1', countId: 'count-icu-intern-1', cap: 8, label: 'ICU Intern 1', increasesCap: false, role: 'ICU Intern', service: 'icu'}, // Using cap 8 for display consistency, logic ignores it
            'icu_intern_2': { nameId: 'name-icu-intern-2', countId: 'count-icu-intern-2', cap: 8, label: 'ICU Intern 2', increasesCap: false, role: 'ICU Intern', service: 'icu'} // Using cap 8 for display consistency, logic ignores it
        };

        // Store base eligibility for display purposes
        for (const teamId in teams) {
            teams[teamId].baseEligibleForIncrease = teams[teamId].increasesCap;
        }

        // Order for displaying people on the status board
        const statusBoardOrder = [
            'gm_oncall', 'gm_postcall', 'gm_prepre', 'gm_precall',
            'tele_oncall', 'tele_postcall', 'nct', 'tele_precall',
            'ri_a', 'ri_b',
            'flex_res_1', 'flex_res_2',
            'icu_intern_1', 'icu_intern_2'
        ];

        // Define the drip order for each service (excluding the primary recipient)
        const genMedDripOrder = ['ri_a', 'gm_prepre', 'gm_precall', 'ri_b'];
        const teleDripOrder = ['ri_b', 'nct', 'tele_precall', 'ri_a']; // RI Residents appear in both drips

        // Track the last assigned person in the *drip* sequence for each service
        let lastDripAssignment = { gm: -1, tele: -1 }; // Index in the respective dripOrder array

        // --- Helper Functions ---

        /**
         * Gets the current information (name, count, cap, etc.) for a team member.
         * @param {string} teamId - The ID of the team member (e.g., 'gm_postcall').
         * @returns {object|null} An object with team info or null if not found.
         */
        function getTeamInfo(teamId) {
            const team = teams[teamId];
            if (!team) return null;
            const nameElement = document.getElementById(team.nameId);
            const name = nameElement ? nameElement.value.trim() || team.label : team.label;
            let count = 0;
            if (team.countId) {
                const countElement = document.getElementById(team.countId);
                count = countElement ? parseInt(countElement.value) || 0 : 0;
            }
             const cap = team.cap !== undefined ? team.cap : 99; // Default to high cap if undefined
            return { ...team, id: teamId, name, count, cap }; // Return all info including calculated cap
        }

        /**
         * Checks if all specified team members have reached a certain count level.
         * Takes individual team caps into account (e.g., NCT cap 3).
         * @param {string[]} teamIdList - Array of team IDs to check.
         * @param {number} capLevel - The count level to check against (e.g., 8 for base cap).
         * @param {object} currentCounts - An object mapping team IDs to their current counts.
         * @returns {boolean} True if all members are at or above the minimum of capLevel and their individual cap.
         */
        function checkAllAtCap(teamIdList, capLevel, currentCounts) {
            for (const teamId of teamIdList) {
                if (!currentCounts.hasOwnProperty(teamId)) continue; // Skip if count not available
                const count = currentCounts[teamId];
                const teamInfo = teams[teamId]; // Get full team info including specific cap
                if (!teamInfo) continue; // Skip if team info not found
                const teamCap = teamInfo.cap; // The actual cap for this team member

                // Check if the count is less than the target level for this check (capLevel),
                // but also respect the individual's hard cap (teamCap).
                // E.g., for NCT (cap 3), checking against capLevel 8 should consider them "at cap" if count is 3.
                if (count < Math.min(capLevel, teamCap)) {
                    return false; // Found someone below the required level
                }
            }
            return true; // Everyone is at or above the required level (considering their individual caps)
        }


        /**
         * Handles the change event for the time selection radio buttons.
         * Resets the drip tracker and updates the board.
         */
        function handleTimeChange() {
            console.log("Time changed, resetting drip tracker.");
            lastDripAssignment = { gm: -1, tele: -1 }; // Reset drip sequence tracking
            updateStatusBoard(); // Update display immediately
            clearResultsList(); // Clear previous sequence lists
        }

        // --- Status Board Update Function ---

        /**
         * Updates the visual status board based on current counts and highlights next admissions.
         * @param {object} nextAdmissionInfo - Object containing arrays of next admissions for gm/tele and the next flex recipient.
         * @param {object[]} nextAdmissionInfo.gm - Array of upcoming GM admissions.
         * @param {object[]} nextAdmissionInfo.tele - Array of upcoming Tele admissions.
         * @param {object|null} nextAdmissionInfo.flex - The next Flex recipient.
         * @param {string} nextAdmissionInfo.message - Message to display (e.g., "All capped").
         */
        function updateStatusBoard(nextAdmissionInfo = { gm: [], tele: [], flex: null, message: "" }) {
            const statusGrid = document.getElementById('status-grid');
            const statusMessage = document.getElementById('status-message');
            statusGrid.innerHTML = ''; // Clear previous board
            statusMessage.textContent = nextAdmissionInfo.message || ''; // Display status message

            const timeContext = document.querySelector('input[name="time-context"]:checked').value;
            const isAfter1PM = timeContext === 'after';
            // Determine who is the *active* on-call based on time
            const activeGmOnCallId = isAfter1PM ? 'gm_oncall' : null;
            const activeTeleOnCallId = isAfter1PM ? 'tele_oncall' : null;

            const currentCounts = {}; // Store counts for potential use elsewhere if needed

            // Iterate through the defined display order
            statusBoardOrder.forEach(teamId => {
                 const teamInfo = getTeamInfo(teamId);
                 if (teamInfo) {
                     currentCounts[teamId] = teamInfo.count; // Store current count
                     const personDiv = document.createElement('div');
                     personDiv.className = 'status-person';

                     // Highlight the border if this person is the active on-call
                     if (teamId === activeGmOnCallId || teamId === activeTeleOnCallId) {
                         personDiv.classList.add('active-on-call');
                     }

                     // Determine role tag color based on service/role
                     let roleClass = '';
                     switch(teamInfo.service) {
                         case 'gm': roleClass = 'role-gm'; break;
                         case 'tele': roleClass = 'role-tele'; break;
                         case 'shared': roleClass = 'role-ri'; break; // RI Residents
                         case 'flex': roleClass = 'role-flex'; break;
                         case 'icu': roleClass = 'role-icu'; break;
                         default: roleClass = 'role-gm'; // Default fallback
                     }
                     // Specific overrides for call status
                     if (teamInfo.role === 'On-Call') roleClass = 'role-oncall';
                     if (teamInfo.role === 'Post-Call') roleClass = 'role-postcall';

                     // Display cap info, unless ICU
                     const capDisplay = teamInfo.service !== 'icu' ? `/ ${teamInfo.cap}` : '';
                     // Display "(CAPPED)" text if count >= cap (and not ICU)
                     const cappedText = teamInfo.service !== 'icu' && teamInfo.count >= teamInfo.cap ? '<span class="status-person-capped"> (CAPPED)</span>' : '';
                     // Display eligibility note based on the *base* eligibility flag (for visual consistency)
                     const eligibleText = teamInfo.service !== 'icu' && teamInfo.baseEligibleForIncrease && teamInfo.count >= teamInfo.cap ? ' <span style="font-style:italic; color: #a16207;">(Eligible+)</span>' : '';


                     // Create the HTML structure for the person
                     personDiv.innerHTML = `
                         <span class="status-person-name">
                             ${teamInfo.name}
                             ${teamInfo.role ? `<span class="role-tag ${roleClass}">${teamInfo.role}</span>` : ''}
                         </span>
                         <div class="slots-container" id="slots-${teamId}"></div>
                         <div class="status-person-count">
                             <span id="count-display-${teamId}">${teamInfo.count}</span> ${capDisplay}
                             ${cappedText}
                             ${eligibleText}
                         </div>
                     `;
                     statusGrid.appendChild(personDiv);

                     const slotsContainer = document.getElementById(`slots-${teamId}`);
                     // Determine max slots to show: 10 for most, 3 for NCT, none effectively for ICU (use cap)
                     const maxSlotsToShow = (teamInfo.service !== 'icu' && teamInfo.cap !== 3) ? 10 : teamInfo.cap;


                     // Create the visual slots
                     for (let i = 0; i < maxSlotsToShow; i++) {
                         const slot = document.createElement('div');
                         slot.className = 'slot';
                         if (i < teamInfo.count) {
                             slot.classList.add('filled'); // Mark as filled if count covers this slot
                         }
                         // Add styling for the 9th and 10th slots if they are being shown
                         if (maxSlotsToShow === 10) {
                             if (i === 8) slot.classList.add('increase-9'); // Dashed border for 9th
                             if (i === 9) slot.classList.add('increase-10'); // Dashed border for 10th
                         }

                         // Check if this slot should be highlighted as the next admission
                         let highlightClass = null;
                         let highlightIndex = -1; // To show the admission number (1st, 2nd, etc.)

                         // Check GM highlights
                         if (nextAdmissionInfo.gm) {
                              nextAdmissionInfo.gm.forEach((adm, index) => {
                                  // Highlight if team matches and slot index matches the count *before* this admission
                                  if (adm.id === teamId && i === adm.countBefore) {
                                      highlightClass = 'next-admission-gm';
                                      highlightIndex = index + 1;
                                  }
                              });
                         }
                         // Check Tele highlights
                         if (nextAdmissionInfo.tele) {
                              nextAdmissionInfo.tele.forEach((adm, index) => {
                                  if (adm.id === teamId && i === adm.countBefore) {
                                      highlightClass = 'next-admission-tele';
                                      highlightIndex = index + 1;
                                  }
                              });
                         }
                         // Check Flex highlight (only one)
                         if (nextAdmissionInfo.flex && nextAdmissionInfo.flex.id === teamId && i === nextAdmissionInfo.flex.count) {
                              highlightClass = 'next-admission-flex';
                              highlightIndex = 1; // Always the '1st' flex admission shown
                         }

                         // Apply highlight class and number if found
                         if (highlightClass) {
                             slot.classList.add(highlightClass);
                             slot.setAttribute('data-next-index', highlightIndex);
                         }

                         slotsContainer.appendChild(slot);
                     }
                 }
            });
        }


        // --- Functions to Determine Next Admission Sequence ---

        /**
         * Calculates the sequence of the next N admissions for a given service (GM or Tele).
         * Simulates the admission process according to the rules (primary, drip, cap increase).
         * @param {string} serviceType - 'gm' or 'tele'.
         * @param {number} [numToCalculate=10] - How many future admissions to calculate.
         * @returns {object} An object containing the calculated sequence and any status message.
         * @returns {object[]} sequence - Array of admission objects {id, name, label, countBefore, capInfo}.
         * @returns {string|null} message - A message if all teams become capped.
         */
        function calculateNextAdmissionsSequence(serviceType, numToCalculate = 10) {
            console.log(`Calculating ${numToCalculate} for ${serviceType}. Initial drip index: ${lastDripAssignment[serviceType]}`);
            const timeContext = document.querySelector('input[name="time-context"]:checked').value;
            const isBefore1PM = timeContext === 'before';
            const serviceName = (serviceType === 'gm') ? 'General Medicine' : 'Telemetry';

            let primaryRecipientId;
            let dripOrder;
            // Set up service-specific primary recipient and drip order
            if (serviceType === 'gm') {
                primaryRecipientId = isBefore1PM ? 'gm_postcall' : 'gm_oncall';
                dripOrder = genMedDripOrder;
            } else { // tele
                primaryRecipientId = isBefore1PM ? 'tele_postcall' : 'tele_oncall';
                dripOrder = teleDripOrder;
            }

            // --- Determine Eligibility for Increase specific to this service context ---
            const isEligibleForIncrease = (teamId) => {
                const team = teams[teamId];
                if (!team || teamId === 'nct') return false; // Base checks: team exists, not NCT

                if (serviceType === 'gm') {
                    // GM: Eligible if their base cap is 8 or more (covers PostCall, PrePre, PreCall, RIs, OnCall)
                    return team.cap >= 8;
                } else { // Tele
                    // Tele: Eligible ONLY if RI Resident or Tele On-Call
                    return team.role === 'RI Res' || teamId === 'tele_oncall';
                }
            };

            // Create a temporary copy of current counts to simulate admissions
            let tempCounts = {};
            const allTeamIds = Object.keys(teams);
            allTeamIds.forEach(id => {
                 const teamInfo = getTeamInfo(id);
                 if (teamInfo && teamInfo.countId) { tempCounts[id] = teamInfo.count; }
            });

            let nextAdmissionsList = []; // Stores the calculated sequence
            let allCappedMessage = null; // Message if simulation ends early
            // Use a *local* drip index for this calculation run, starting from the last known state
            let currentDripIndex = lastDripAssignment[serviceType];

            // Simulate N admissions
            for (let i = 0; i < numToCalculate; i++) {
                let admissionAssignedThisIteration = false;
                let assignedTo = null;
                let capInfoText = ''; // Text describing why this person got the admission (e.g., Primary, Drip, Increased Cap)
                let teamLabel = ''; // Label of the assigned team member

                // --- Admission Logic Steps ---

                // 1. Check Primary Recipient (Base Cap)
                const primaryInfo = getTeamInfo(primaryRecipientId);
                const primaryCurrentCount = tempCounts[primaryRecipientId];
                // Assign if primary exists and is below their defined cap
                if (primaryInfo && primaryCurrentCount < primaryInfo.cap) {
                    assignedTo = primaryRecipientId;
                    capInfoText = `(Primary - Base Cap: ${primaryInfo.cap})`;
                    teamLabel = primaryInfo.label;
                    admissionAssignedThisIteration = true;
                }

                // 2. Check Drip Order (Base Cap) - Only if primary didn't take it
                if (!admissionAssignedThisIteration) {
                    let initialDripIndex = currentDripIndex; // Start searching from the next person in the drip
                    for (let j = 0; j < dripOrder.length; j++) {
                        let checkIndex = (initialDripIndex + 1 + j) % dripOrder.length; // Cycle through drip order
                        const currentDripTeamId = dripOrder[checkIndex];
                        const teamInfo = getTeamInfo(currentDripTeamId);
                        const currentCount = tempCounts[currentDripTeamId];
                        // Assign if team exists and is below their defined cap
                        if (teamInfo && currentCount < teamInfo.cap) {
                            assignedTo = currentDripTeamId;
                            capInfoText = `(Drip - Base Cap: ${teamInfo.cap})`;
                            teamLabel = teamInfo.label;
                            currentDripIndex = checkIndex; // Update the drip index locally for this calculation
                            admissionAssignedThisIteration = true;
                            break; // Stop searching drip once assigned
                        }
                    }
                }

                // 3. Check Cap Increase to 9 - Only if not assigned yet
                if (!admissionAssignedThisIteration) {
                     // Define the list of teams relevant for *triggering* the increase for this service
                     const teamsToCheckBase = [primaryRecipientId, ...dripOrder];
                     // Check if ALL relevant teams are at their respective base caps (using 8 as the general base, checkAllAtCap handles NCT's cap 3)
                     const allAtBase = checkAllAtCap(teamsToCheckBase, 8, tempCounts);

                     if (allAtBase) { // Only proceed if trigger condition met
                         let initialDripIndex = currentDripIndex;
                         // Check drip members first for the 9th admission
                         for (let j = 0; j < dripOrder.length; j++) {
                             let checkIndex = (initialDripIndex + 1 + j) % dripOrder.length;
                             const currentDripTeamId = dripOrder[checkIndex];
                             const teamInfo = getTeamInfo(currentDripTeamId);
                             const currentCount = tempCounts[currentDripTeamId];
                             // Assign if team exists, is ELIGIBLE for increase (service-specific check), and count is below 9
                             if (teamInfo && isEligibleForIncrease(currentDripTeamId) && currentCount < 9) {
                                 assignedTo = currentDripTeamId;
                                 capInfoText = `(Drip - Increased Cap: 9)`;
                                 teamLabel = teamInfo.label;
                                 currentDripIndex = checkIndex; // Update local drip index
                                 admissionAssignedThisIteration = true;
                                 break;
                             }
                         }
                         // If no drip member took it, check the primary recipient
                         if (!admissionAssignedThisIteration && primaryInfo && isEligibleForIncrease(primaryRecipientId) && primaryCurrentCount < 9) {
                             assignedTo = primaryRecipientId;
                             capInfoText = `(Primary - Increased Cap: 9)`;
                             teamLabel = primaryInfo.label;
                             admissionAssignedThisIteration = true;
                         }
                     }
                }

                 // 4. Check Cap Increase to 10 - Only if not assigned yet
                 if (!admissionAssignedThisIteration) {
                     const teamsToCheckBase = [primaryRecipientId, ...dripOrder];
                     // Check if all relevant teams are at base cap (8)
                     const allAtBase = checkAllAtCap(teamsToCheckBase, 8, tempCounts);
                     if (allAtBase) {
                         // Define the list of teams ELIGIBLE for increase within this service
                         const teamsEligibleForIncrease = teamsToCheckBase.filter(id => isEligibleForIncrease(id));
                         // Check if all *eligible* teams have reached 9
                         const allEligibleAt9 = checkAllAtCap(teamsEligibleForIncrease, 9, tempCounts);

                         if (allEligibleAt9) { // Only proceed if trigger (all base) and secondary trigger (all eligible at 9) met
                              let initialDripIndex = currentDripIndex;
                             // Check drip members first for the 10th admission
                             for (let j = 0; j < dripOrder.length; j++) {
                                 let checkIndex = (initialDripIndex + 1 + j) % dripOrder.length;
                                 const currentDripTeamId = dripOrder[checkIndex];
                                 const teamInfo = getTeamInfo(currentDripTeamId);
                                 const currentCount = tempCounts[currentDripTeamId];
                                 // Assign if team exists, is ELIGIBLE, and count is below 10
                                 if (teamInfo && isEligibleForIncrease(currentDripTeamId) && currentCount < 10) {
                                     assignedTo = currentDripTeamId;
                                     capInfoText = `(Drip - Increased Cap: 10)`;
                                     teamLabel = teamInfo.label;
                                     currentDripIndex = checkIndex; // Update local drip index
                                     admissionAssignedThisIteration = true;
                                     break;
                                 }
                             }
                             // If no drip member took it, check the primary recipient
                             if (!admissionAssignedThisIteration && primaryInfo && isEligibleForIncrease(primaryRecipientId) && primaryCurrentCount < 10) {
                                 assignedTo = primaryRecipientId;
                                 capInfoText = `(Primary - Increased Cap: 10)`;
                                 teamLabel = primaryInfo.label;
                                 admissionAssignedThisIteration = true;
                             }
                         }
                     }
                 }

                // 5. Handle Assignment or Capped State
                if (admissionAssignedThisIteration && assignedTo) {
                    const recipientInfo = getTeamInfo(assignedTo); // Get full info for name/label
                    nextAdmissionsList.push({
                        id: assignedTo,
                        name: recipientInfo.name, // Use the potentially user-entered name
                        label: teamLabel, // Use the role/label determined during assignment
                        countBefore: tempCounts[assignedTo], // Record count *before* incrementing
                        capInfo: capInfoText // Record the reason for assignment
                    });
                    tempCounts[assignedTo]++; // Increment the count in the temporary simulation
                 } else {
                    // If no one could take the admission in this iteration, all relevant teams are capped.
                    allCappedMessage = `All ${serviceName.toUpperCase()} teams are CAPPED after ${i} potential admissions.`;
                    break; // Stop the simulation loop
                }
            } // End simulation loop (for i < numToCalculate)

             // --- Update the persistent drip tracker based on the *last* drip assignment in this calculation ---
             // This ensures the next calculation starts correctly.
             if (nextAdmissionsList.length > 0) {
                 const lastAssignedAdmission = nextAdmissionsList[nextAdmissionsList.length - 1];
                 // Check if the last person assigned was part of the drip order
                 if (dripOrder.includes(lastAssignedAdmission.id)) {
                     // Update the global tracker to the index of the last assigned drip member
                     lastDripAssignment[serviceType] = dripOrder.indexOf(lastAssignedAdmission.id);
                 }
                 // If the last assignment was to the primary, the drip index remains where it was before this calculation started.
             }
             console.log(`Finished ${serviceType} sequence calc. Final drip index: ${lastDripAssignment[serviceType]}`);


            return { sequence: nextAdmissionsList, message: allCappedMessage };
        }


        /**
         * Determines the next Flex resident to receive an OBS admission.
         * @returns {object} Object containing the recipient and any message.
         * @returns {object|null} recipient - Info of the next recipient {id, count, name} or null.
         * @returns {string|null} message - Message if both are capped or error.
         */
        function getNextFlexAdmission() {
            const flexRes1Info = getTeamInfo('flex_res_1');
            const flexRes2Info = getTeamInfo('flex_res_2');
            let nextRecipient = null;
            let message = null;

            if (!flexRes1Info || !flexRes2Info) {
                message = "Error: Could not retrieve Flex Resident information.";
            } else {
                const res1Count = flexRes1Info.count;
                const res2Count = flexRes2Info.count;
                const res1Cap = flexRes1Info.cap;
                const res2Cap = flexRes2Info.cap;

                // Assign to Res 1 if they are below cap AND (have fewer or equal patients OR Res 2 is capped)
                if (res1Count < res1Cap && (res1Count <= res2Count || res2Count >= res2Cap)) {
                    nextRecipient = { id: 'flex_res_1', count: res1Count, name: flexRes1Info.name };
                // Otherwise, assign to Res 2 if they are below cap
                } else if (res2Count < res2Cap) {
                    nextRecipient = { id: 'flex_res_2', count: res2Count, name: flexRes2Info.name };
                // Otherwise, both must be capped
                } else {
                    message = "Both Flex Residents are CAPPED.";
                }
            }
            return { recipient: nextRecipient, message: message };
        }

        // --- Function to update the text results list ---

        /**
         * Populates the ordered lists below the status board with the calculated sequences.
         * @param {object[]} gmSequence - Array of GM admission objects from calculation.
         * @param {object[]} teleSequence - Array of Tele admission objects from calculation.
         */
        function updateResultsList(gmSequence, teleSequence) {
            const listContainer = document.getElementById('results-list');
            const gmList = document.getElementById('gm-results-list');
            const teleList = document.getElementById('tele-results-list');
            gmList.innerHTML = ''; // Clear previous list
            teleList.innerHTML = ''; // Clear previous list

            const gmCol = document.getElementById('gm-results-col');
            const teleCol = document.getElementById('tele-results-col');

            // Update GM List
            if (gmSequence && gmSequence.length > 0) {
                gmCol.style.display = 'block'; // Show the column
                gmList.parentElement.querySelector('h3').textContent = `Next ${gmSequence.length} GM Admissions`; // Update heading count
                gmSequence.forEach(adm => {
                    const li = document.createElement('li');
                    // Display Name (Team Label) Cap Info
                    li.innerHTML = `<strong>${adm.name}</strong> <span class="team-label">(${adm.label})</span> <span class="cap-detail">${adm.capInfo}</span>`;
                    gmList.appendChild(li);
                });
            } else {
                 gmCol.style.display = 'block'; // Still show column for the message
                 gmList.parentElement.querySelector('h3').textContent = `Next GM Admissions`;
                 gmList.innerHTML = '<li class="no-results">No further GM admissions possible.</li>';
            }

             // Update Tele List
             if (teleSequence && teleSequence.length > 0) {
                 teleCol.style.display = 'block'; // Show the column
                 teleList.parentElement.querySelector('h3').textContent = `Next ${teleSequence.length} Tele Admissions`; // Update heading count
                 teleSequence.forEach(adm => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${adm.name}</strong> <span class="team-label">(${adm.label})</span> <span class="cap-detail">${adm.capInfo}</span>`;
                    teleList.appendChild(li);
                });
            } else {
                 teleCol.style.display = 'block'; // Still show column for the message
                  teleList.parentElement.querySelector('h3').textContent = `Next Tele Admissions`;
                 teleList.innerHTML = '<li class="no-results">No further Tele admissions possible.</li>';
            }

            // Show the main results container only if at least one list has content (or a "no results" message)
            listContainer.style.display = 'block';
        }

        /**
         * Clears the results lists and hides the container.
         */
         function clearResultsList() {
             const listContainer = document.getElementById('results-list');
             document.getElementById('gm-results-list').innerHTML = '';
             document.getElementById('tele-results-list').innerHTML = '';
             listContainer.style.display = 'none'; // Hide the container
         }


        // --- Button Click Handlers ---

        /**
         * Calculates and highlights the next admission sequence for a specific service (GM or Tele).
         * Also updates the corresponding results list.
         * @param {string} serviceType - 'gm' or 'tele'.
         */
        function highlightNextAdmissionSequence(serviceType) {
            const result = calculateNextAdmissionsSequence(serviceType, 10); // Calculate next 10
            let nextAdmissionInfo = { gm: [], tele: [], flex: null, message: result.message };
            let gmList = null;
            let teleList = null;

            // Populate the correct service array in nextAdmissionInfo
            if (serviceType === 'gm') {
                nextAdmissionInfo.gm = result.sequence;
                gmList = result.sequence; // For updating the list
            } else {
                nextAdmissionInfo.tele = result.sequence;
                teleList = result.sequence; // For updating the list
            }
            updateStatusBoard(nextAdmissionInfo); // Update highlights on the board
            updateResultsList(gmList, teleList); // Update the text list(s)
        }

        /**
         * Calculates and highlights the next Flex admission.
         * Clears the GM/Tele results lists.
         */
        function highlightNextFlexAdmission() {
            const result = getNextFlexAdmission();
            let nextAdmissionInfo = { gm: [], tele: [], flex: null, message: result.message };
            if (result.recipient) {
                nextAdmissionInfo.flex = result.recipient; // Set the flex highlight info
            }
             updateStatusBoard(nextAdmissionInfo); // Update board (clears GM/Tele highlights)
             clearResultsList(); // Hide and clear GM/Tele lists
        }

        /**
         * Calculates and highlights admissions for ALL services (GM, Tele, Flex).
         * Updates both GM and Tele results lists.
         */
        function highlightAllServices() {
             // Calculate sequences independently first
             const gmResult = calculateNextAdmissionsSequence('gm', 10);
             const teleResult = calculateNextAdmissionsSequence('tele', 10);
             const flexResult = getNextFlexAdmission();

             // Combine any capped messages
             let combinedMessage = "";
             if (gmResult.message) combinedMessage += gmResult.message + " ";
             if (teleResult.message) combinedMessage += teleResult.message + " ";
             if (flexResult.message) combinedMessage += flexResult.message;

             // Update the status board with all highlights
             updateStatusBoard({
                 gm: gmResult.sequence,
                 tele: teleResult.sequence,
                 flex: flexResult.recipient,
                 message: combinedMessage.trim() || null // Show combined message or nothing
             });
             // Update both results lists
             updateResultsList(gmResult.sequence, teleResult.sequence);
         }


        /**
         * Resets all counts to 0, clears names, sets time to default, and updates the display.
         */
        function resetCounts() {
            for (const teamId in teams) {
                const team = teams[teamId];
                 // Reset count input if it exists
                 const countElement = document.getElementById(team.countId);
                 if (countElement) { countElement.value = 0; }
                 // Reset name input if it exists
                 const nameElement = document.getElementById(team.nameId);
                  if (nameElement && nameElement.type === 'text') { nameElement.value = ''; }
            }
            // Reset time selection to default
            document.getElementById('time-before-1pm').checked = true;
            // Reset the global drip tracker
            lastDripAssignment = { gm: -1, tele: -1 };
            // Update the board (clears highlights)
            updateStatusBoard();
            // Clear the results lists
            clearResultsList();
            // Provide feedback
            document.getElementById('status-message').textContent = "All counts and names reset.";
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            updateStatusBoard(); // Initial draw of the status board
            // Add event listeners for time change
            document.querySelectorAll('input[name="time-context"]').forEach(radio => {
                radio.addEventListener('change', handleTimeChange);
            });
            // Add event listeners to all input fields to update the board dynamically
            document.querySelectorAll('.input-wrapper input').forEach(input => {
                input.addEventListener('input', () => updateStatusBoard()); // Update board on any input change
            });
        });

    </script>

</body>
</html>
