<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Distribution Tool (DRIP System - G - v9)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset and Font */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            background-color: #f1f5f9; /* bg-slate-100 */
            padding: 20px;
        }

        /* Main Container */
        .main-container {
            max-width: 1280px; /* Wider layout for 4 columns */
            margin: 20px auto;
            background: linear-gradient(to bottom, white, #f8fafc); /* from-white to-slate-50 */
            padding: 24px; /* p-6 */
            border-radius: 12px; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            border: 1px solid #e2e8f0; /* border-slate-200 */
        }

        /* Headings and Text */
        h1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1e293b; /* text-slate-800 */
            margin-bottom: 0.5rem; /* mb-2 */
            text-align: center;
            padding-bottom: 10px;
             border-bottom: 1px solid #e5e7eb; /* border-slate-200 */
        }

        .subtitle {
            font-size: 1rem; /* text-base */
            color: #475569; /* text-slate-600 */
            margin-bottom: 1rem; /* mb-4 */
            text-align: center;
        }

        /* Time Selection */
         .time-selection {
             text-align: center;
             margin-bottom: 2rem; /* mb-8 */
             padding: 12px;
             background-color: #e0f2fe; /* bg-sky-100 */
             border: 1px solid #bae6fd; /* border-sky-200 */
             border-radius: 8px;
         }
         .time-selection label {
             margin: 0 10px 0 5px;
             font-weight: 500;
             color: #0c4a6e; /* sky-800 */
             cursor: pointer;
         }
         .time-selection input[type="radio"] {
             cursor: pointer;
             accent-color: #0369a1; /* sky-700 */
         }
         .time-selection strong {
             color: #075985; /* sky-800 */
             margin-right: 15px;
         }


        /* Content Layout (Grid for 4 columns) */
        .content-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 24px; /* gap-6 */
        }

        /* Service Section Styling (using fieldset) */
        fieldset.service-section {
            border: 1px solid #e2e8f0; /* border-slate-200 */
            padding: 20px; /* p-5 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            background-color: white; /* bg-white */
            margin-bottom: 1.5rem; /* Maintain spacing */
        }
         /* Specific styling for RI section */
         fieldset.ri-section {
             border-color: #1d4ed8; /* border-blue-700 */
             background-color: #eff6ff; /* bg-blue-50 */
         }
         fieldset.ri-section legend {
             color: #1d4ed8; /* text-blue-700 */
         }


        legend {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #1e293b; /* text-slate-800 */
            padding: 0 8px; /* px-2 */
            margin-left: -8px; /* Adjust alignment */
            margin-bottom: 15px;
        }

        /* Team Member / Input Group Styling */
        .team-member {
            border: 1px solid #e5e7eb; /* border-slate-200 */
            padding: 12px; /* p-3 */
            margin-bottom: 12px; /* mb-3 */
            border-radius: 6px; /* rounded-md */
            background-color: #f9fafb; /* bg-slate-50 */
        }
         /* On-Call Input Styling */
        .on-call-section {
             border: 1px dashed #94a3b8; /* border-slate-400 */
             padding: 12px;
             margin-bottom: 15px;
             border-radius: 6px;
             background-color: #f8fafc; /* bg-slate-50 */
        }
         .on-call-section label {
             font-weight: 600; /* font-semibold */
             color: #0f766e; /* teal-700 */
         }


        /* Labels */
        label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #334155; /* text-slate-700 */
            margin-bottom: 4px; /* mb-1 */
        }

        /* Inputs */
        input[type="text"], input[type="number"] {
            margin-top: 4px; /* mt-1 */
            display: block;
            width: 100%;
            border-radius: 6px; /* rounded-md */
            border: 1px solid #cbd5e1; /* border-slate-300 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            padding: 8px 10px; /* p-2 py-2 */
            background-color: white; /* bg-white */
            color: #0f172a; /* text-slate-900 */
            font-size: 0.875rem; /* sm:text-sm */
            margin-bottom: 8px; /* Add some space below input */
        }
        input[type="number"] {
             width: 80px; /* Slightly wider number input */
             display: inline-block; /* Allow label beside it if needed */
             margin-right: 10px;
        }

         input:focus {
             border-color: #3b82f6; /* focus:border-blue-500 */
             outline: 1px solid #3b82f6; /* Simple focus ring */
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* focus:ring approximation */
         }

        /* Cap Info Styling */
        .cap-info {
            font-size: 0.8rem; /* text-xs slightly larger */
            color: #64748b; /* text-slate-500 */
            display: block; /* Ensure it's on its own line */
            margin-top: 4px; /* mt-1 */
        }
        .cap-increase-note {
            font-size: 0.875rem; /* text-sm */
            color: #be123c; /* text-rose-700 */
            font-weight: 500; /* font-medium */
            margin-bottom: 1rem; /* mb-4 */
            padding: 8px;
            background-color: #ffe4e6; /* rose-100 */
            border: 1px solid #fda4af; /* rose-300 */
            border-radius: 4px;
        }


        /* Button Container */
        .button-container {
            margin-top: 2rem; /* mt-8 */
            padding: 1rem; /* p-4 */
            background-color: #f8fafc; /* bg-slate-50 */
            border-top: 1px solid #e2e8f0; /* border-t border-slate-200 */
            display: flex;
            justify-content: center;
            gap: 1rem; /* space-x-4 */
            flex-wrap: wrap; /* Allow buttons to wrap */
        }

        /* Buttons */
        button {
            padding: 10px 18px; /* px-6 py-2.5 adjusted */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            border-radius: 6px; /* rounded-md */
            border: none;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            line-height: 1.5; /* Ensure text vertical alignment */
            margin-top: 5px; /* Add small top margin for stacked buttons */
        }

        button:focus {
             outline: 2px solid transparent; /* focus:outline-none */
             outline-offset: 2px;
             box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.5); /* focus:ring approximation */
        }

        button:disabled {
            opacity: 0.6; /* disabled:opacity-60 */
            cursor: not-allowed; /* disabled:cursor-not-allowed */
        }

        /* Primary Button Style */
        .btn-primary {
            background-color: #2563eb; /* bg-blue-600 */
            color: white; /* text-white */
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }
         .btn-primary:focus {
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
         }

        /* Secondary Button Style */
        .btn-secondary {
            background-color: #e2e8f0; /* bg-slate-200 */
            color: #1e293b; /* text-slate-800 */
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* hover:bg-slate-300 */
        }
         .btn-secondary:focus {
             box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.5); /* focus:ring-slate-400 */
         }

        /* Results Area */
        #output {
            margin-top: 2rem; /* mt-8 */
            padding: 1.25rem; /* p-5 */
            background-color: #eff6ff; /* bg-blue-50 */
            border: 1px solid #bfdbfe; /* border-blue-200 */
            border-radius: 8px; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow */
            color: #1e3a8a; /* text-blue-900 */
            font-size: 0.95rem; /* Slightly smaller base for list */
            line-height: 1.6;
            min-height: 150px; /* Ensure it has enough height for list */
            text-align: left; /* Align text left for list */
            display: flex; /* Use flex for alignment */
            flex-direction: column; /* Stack content vertically */
            align-items: center; /* Center items horizontally */
            justify-content: center; /* Center content block vertically if short */
        }
         #output strong {
             color: #1d4ed8; /* text-blue-700 */
             font-weight: 600;
         }
         #output .time-context-display {
             font-weight: 600;
             color: #0f766e; /* teal-700 */
             margin-bottom: 1rem;
             display: block;
             padding-bottom: 0.5rem;
             border-bottom: 1px dashed #99f6e4; /* teal-200 */
             text-align: center; /* Center the text */
             width: 100%; /* Take full width */
         }
         #output ol {
             margin-top: 0.5rem;
             padding-left: 1.75rem; /* Indent list */
             list-style-type: decimal;
             text-align: left; /* Align list items left */
             width: 100%; /* Allow list to take width */
             align-self: flex-start; /* Align list itself to the left */
             padding-left: 30%; /* Adjust padding for centering effect */
             box-sizing: border-box;
         }
          @media (max-width: 600px) { /* Adjust list padding on smaller screens */
             #output ol {
                 padding-left: 1.75rem;
             }
         }
         #output li {
             margin-bottom: 0.5rem; /* Space between list items */
             color: #1e40af; /* text-blue-800 */
         }
         #output li .cap-detail {
             font-size: 0.8rem;
             font-style: italic;
             color: #64748b; /* text-slate-500 */
             margin-left: 5px;
         }
         #output .all-capped-message {
             font-weight: bold;
             color: #be123c; /* text-rose-700 */
             text-align: center;
             margin-top: 1rem;
             width: 100%; /* Ensure capped message takes width */
         }


        /* Notes Area Styling */
        .notes {
             margin-top: 2.5rem; /* mt-10 */
             font-size: 0.875rem; /* text-sm */
             color: #475569; /* text-slate-600 */
             border-top: 1px solid #e2e8f0; /* border-t border-slate-200 */
             padding-top: 1rem; /* pt-4 */
             background-color: #f8fafc; /* bg-slate-50 */
             padding: 1rem;
             border-radius: 8px; /* rounded-lg */
             grid-column: 1 / -1; /* Make notes span all columns */
        }
        .notes h3 {
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            color: #334155; /* text-slate-700 */
            margin-bottom: 0.75rem; /* mb-3 */
        }
         .notes ul {
             list-style-position: outside;
             list-style-type: disc;
             margin-top: 0.5rem;
             padding-left: 1.5rem; /* pl-6 */
         }
         .notes ul ul { /* Nested lists */
             margin-left: 1.25rem; /* ml-5 */
             margin-top: 0.25rem;
             list-style-type: circle;
         }
         .notes li {
             margin-bottom: 0.5rem; /* mb-2 */
         }
         .notes strong {
             font-weight: 600;
             color: #1e293b; /* text-slate-800 */
         }
         .notes em {
             font-style: italic;
             color: #0f766e; /* teal-700 */
         }


        /* Responsive Adjustments */
        @media (min-width: 768px) { /* md breakpoint */
            body {
                 padding: 30px; /* Replaces md:p-8 */
            }
            .main-container {
                 padding: 32px; /* md:p-8 */
            }
        }

    </style>
</head>
<body>

    <div class="main-container">
        <h1>Admission Distribution Tool</h1>
        <p class="subtitle">DRIP System - G (Valid: 2 Flex Res + 2 RI Res) - Next 7 Admissions</p>

        <div class="time-selection">
            <strong>Current Time:</strong>
            <input type="radio" id="time-before-1pm" name="time-context" value="before" checked onchange="handleTimeChange()">
            <label for="time-before-1pm">Before 1 PM</label>
            <input type="radio" id="time-after-1pm" name="time-context" value="after" onchange="handleTimeChange()">
            <label for="time-after-1pm">1 PM or Later</label>
        </div>


        <div class="content-wrapper">

            <fieldset class="service-section">
                <legend>General Medicine (GM)</legend>
                <p class="cap-increase-note">Cap increase to 9/10 only occurs after ALL GM drip members (including primary) reach base cap.</p>

                <div class="on-call-section">
                    <label for="name-gm-oncall">GM On-Call Intern Name:</label>
                    <input type="text" id="name-gm-oncall" placeholder="Enter name">
                    <label for="count-gm-oncall">Current Count:</label>
                    <input type="number" id="count-gm-oncall" value="0" min="0" max="15">
                    <span class="cap-info">(Cap: 8) - Takes admissions first <strong style='color:#0f766e;'>after 1 PM</strong> until capped.</span>
                </div>

                 <div class="team-member">
                    <label for="name-gm-postcall">GM Post Call Intern Name:</label>
                    <input type="text" id="name-gm-postcall" placeholder="Optional Name">
                    <label for="count-gm-postcall">Current Count:</label>
                    <input type="number" id="count-gm-postcall" value="0" min="0" max="15">
                    <span class="cap-info">(Cap: 8, Increases to 9-10) - Takes admissions first <strong style='color:#0f766e;'>before 1 PM</strong> until capped.</span>
                </div>
                <div class="team-member">
                    <label for="name-gm-prepre">GM Pre-Pre Call Intern Name:</label>
                    <input type="text" id="name-gm-prepre" placeholder="Optional Name">
                    <label for="count-gm-prepre">Current Count:</label>
                    <input type="number" id="count-gm-prepre" value="0" min="0" max="15">
                    <span class="cap-info">(Cap: 8, Increases to 9-10)</span>
                </div>
                <div class="team-member">
                    <label for="name-gm-precall">GM Pre-Call Intern Name:</label>
                    <input type="text" id="name-gm-precall" placeholder="Optional Name">
                    <label for="count-gm-precall">Current Count:</label>
                    <input type="number" id="count-gm-precall" value="0" min="0" max="15">
                    <span class="cap-info">(Cap: 8, Increases to 9-10)</span>
                </div>
                <button onclick="findNextAdmissions('gm')" class="btn-primary" style="width:100%; margin-top: 10px;">Find Next 7 GM Admissions</button>
            </fieldset>

            <fieldset class="service-section">
                <legend>Telemetry (Tele)</legend>
                 <p class="cap-increase-note">Cap increase to 9/10 only occurs after ALL Tele drip members (including primary) reach base cap.</p>

                 <div class="on-call-section">
                     <label for="name-tele-oncall">Tele On-Call Intern Name:</label>
                     <input type="text" id="name-tele-oncall" placeholder="Enter name">
                     <label for="count-tele-oncall">Current Count:</label>
                     <input type="number" id="count-tele-oncall" value="0" min="0" max="15">
                     <span class="cap-info">(Cap: 8) - Takes admissions first <strong style='color:#0f766e;'>after 1 PM</strong> until capped.</span>
                 </div>

                 <div class="team-member">
                    <label for="name-tele-postcall">Tele Post Call Intern Name:</label>
                    <input type="text" id="name-tele-postcall" placeholder="Optional Name">
                    <label for="count-tele-postcall">Current Count:</label>
                    <input type="number" id="count-tele-postcall" value="0" min="0" max="15">
                     <span class="cap-info">(Cap: 8) - Takes admissions first <strong style='color:#0f766e;'>before 1 PM</strong> until capped.</span>
                 </div>
                 <div class="team-member">
                    <label for="name-nct">NCT Resident Name:</label>
                    <input type="text" id="name-nct" placeholder="Optional Name">
                    <label for="count-nct">Current Count:</label>
                    <input type="number" id="count-nct" value="0" min="0" max="10">
                    <span class="cap-info">(Cap: 3)</span>
                </div>
                 <div class="team-member">
                    <label for="name-tele-precall">Tele Pre-call Intern Name:</label>
                    <input type="text" id="name-tele-precall" placeholder="Optional Name">
                    <label for="count-tele-precall">Current Count:</label>
                    <input type="number" id="count-tele-precall" value="0" min="0" max="15">
                     <span class="cap-info">(Cap: 8)</span>
                 </div>
                <button onclick="findNextAdmissions('tele')" class="btn-primary" style="width:100%; margin-top: 10px;">Find Next 7 Tele Admissions</button>
            </fieldset>

             <fieldset class="service-section ri-section">
                <legend>RI Residents (Shared)</legend>

                <div class="team-member">
                    <label for="name-ri-a">RI Res A Name:</label>
                    <input type="text" id="name-ri-a" placeholder="Resident Name">
                    <label for="count-ri-a">Total Count (GM + Tele):</label>
                    <input type="number" id="count-ri-a" value="0" min="0" max="15">
                    <span class="cap-info">(Total Cap: 8, Increases to 9-10 based on service need)</span>
                </div>
                 <div class="team-member">
                    <label for="name-ri-b">RI Res B Name:</label>
                    <input type="text" id="name-ri-b" placeholder="Resident Name">
                    <label for="count-ri-b">Total Count (GM + Tele):</label>
                    <input type="number" id="count-ri-b" value="0" min="0" max="15">
                    <span class="cap-info">(Total Cap: 8, Increases to 9-10 based on service need)</span>
               </div>
            </fieldset>

            <fieldset class="service-section">
                <legend>Flex / Observation Team</legend>
                <div class="team-member">
                    <label for="name-flex-res-1">Flex Resident 1 Name:</label>
                    <input type="text" id="name-flex-res-1" placeholder="e.g., Flex Res Alpha">
                    <label for="count-flex-res-1">Current Count:</label>
                    <input type="number" id="count-flex-res-1" value="0" min="0" max="10">
                    <span class="cap-info">(Cap: 8. OBS Pts ONLY)</span>
                 </div>
                 <div class="team-member">
                    <label for="name-flex-res-2">Flex Resident 2 Name:</label>
                    <input type="text" id="name-flex-res-2" placeholder="e.g., Flex Res Bravo">
                    <label for="count-flex-res-2">Current Count:</label>
                    <input type="number" id="count-flex-res-2" value="0" min="0" max="10">
                    <span class="cap-info">(Cap: 8. OBS Pts ONLY)</span>
                </div>
                 <button onclick="findNextFlexAdmission()" class="btn-primary" style="width:100%;">Find Next Flex/OBS Admission</button>
            </fieldset>

        </div> <div id="output">
             Select the current time context, enter counts, and click a button to find the next admission(s).
        </div>

         <div class="button-container">
             <button onclick="resetCounts()" class="btn-secondary">Reset All Counts & Names</button>
         </div>


        <div class="notes">
            <h3>System Notes:</h3>
            <ul>
                 <li><strong>Time Context:</strong> Select "Before 1 PM" or "1 PM or Later" to determine the admission sequence.</li>
                 <li><strong>Primary Recipient:</strong> Before 1 PM, the Post-Call intern takes admissions first until capped (8). After 1 PM, the On-Call intern takes first until capped (8).</li>
                 <li><strong>Drip Sequence (Round-Robin):</strong> After the primary recipient is capped, subsequent admissions cycle through the remaining eligible team members (RI Res, Pre-Pre, Pre-Call, NCT) one by one. The tool finds the *next* person in the cycle who is below their base cap.</li>
                 <li><strong>Cap Increase Timing:</strong> Increases to 9/10 only occur after the primary recipient AND *all* members of the standard drip sequence have reached their base caps. The increase is then applied round-robin to eligible members.</li>
                 <li><strong>On-Call Interns:</strong> Have counts/caps (8). Only receive drip admissions after 1 PM (filling first). Do not participate in cap increase to 9/10.</li>
                 <li><strong>RI Residents (Combined Counts):</strong> Have a single total count. Base cap 8. Participate in cap increase to 9/10 based on service need.</li>
                <li><strong>Gowda Patients:</strong> Distributed equally within the drip system (follow the standard drip).</li>
                <li><strong>Weekend Distribution:</strong> Manual 'keep' logic applies (see PDF/local guidelines). This tool calculates the sequence based on time/caps.</li>
                <li><strong>Flex/OBS Team:</strong> Two residents, each capped at 8 OBS patients. Next admission goes to the resident with the lower count.</li>
                 <li><strong>Cap Increase Eligibility (GM):</strong> RI Res A, RI Res B, GM Post Call, GM Pre-Pre Call, GM Pre-Call.</li>
                 <li><strong>Cap Increase Eligibility (Tele):</strong> RI Res A, RI Res B ONLY.</li>
            </ul>
        </div>

    </div> <script>
        // Define team structure and base parameters
        const teams = {
            // RI Residents (Shared Count)
            'ri_a': { nameId: 'name-ri-a', countId: 'count-ri-a', cap: 8, label: 'RI Res A', increasesCapGM: true, increasesCapTele: true },
            'ri_b': { nameId: 'name-ri-b', countId: 'count-ri-b', cap: 8, label: 'RI Res B', increasesCapGM: true, increasesCapTele: true },
            // Gen Med Specific Interns
            'gm_postcall': { nameId: 'name-gm-postcall', countId: 'count-gm-postcall', cap: 8, label: 'GM Post Call Intern', increasesCapGM: true, increasesCapTele: false },
            'gm_prepre': { nameId: 'name-gm-prepre', countId: 'count-gm-prepre', cap: 8, label: 'GM Pre-Pre Call Intern', increasesCapGM: true, increasesCapTele: false },
            'gm_precall': { nameId: 'name-gm-precall', countId: 'count-gm-precall', cap: 8, label: 'GM Pre-Call Intern', increasesCapGM: true, increasesCapTele: false },
            // Tele Specific Interns/Residents
            'tele_postcall': { nameId: 'name-tele-postcall', countId: 'count-tele-postcall', cap: 8, label: 'Tele Post Call Intern', increasesCapGM: false, increasesCapTele: false },
            'nct': { nameId: 'name-nct', countId: 'count-nct', cap: 3, label: 'NCT Resident', increasesCapGM: false, increasesCapTele: false },
            'tele_precall': { nameId: 'name-tele-precall', countId: 'count-tele-precall', cap: 8, label: 'Tele Pre-call Intern', increasesCapGM: false, increasesCapTele: false },
            // Flex Team Residents
            'flex_res_1': { nameId: 'name-flex-res-1', countId: 'count-flex-res-1', cap: 8, label: 'Flex Resident 1' },
            'flex_res_2': { nameId: 'name-flex-res-2', countId: 'count-flex-res-2', cap: 8, label: 'Flex Resident 2' },
             // On Call (Now with counts, potential primary recipient after 1 PM)
             'gm_oncall': { nameId: 'name-gm-oncall', countId: 'count-gm-oncall', cap: 8, label: 'GM On-Call Intern', increasesCapGM: false, increasesCapTele: false }, // No cap increase
             'tele_oncall': { nameId: 'name-tele-oncall', countId: 'count-tele-oncall', cap: 8, label: 'Tele On-Call Intern', increasesCapGM: false, increasesCapTele: false } // No cap increase
        };

        // --- Define Base Drip Orders (excluding primary recipient) ---
        // These define the round-robin sequence *after* Post/On-Call is handled
        const genMedDripOrder = ['ri_a', 'gm_prepre', 'gm_precall', 'ri_b'];
        const teleDripOrder = ['ri_b', 'nct', 'tele_precall', 'ri_a'];

        // --- State for Round-Robin Tracking ---
        // Stores the index within the *dripOrder* array (e.g., genMedDripOrder)
        // Reset when time context changes or reset button is clicked
        let lastDripAssignment = {
            gm: -1, // Index in genMedDripOrder
            tele: -1 // Index in teleDripOrder
        };

        // --- Helper Functions ---
        function getTeamInfo(teamId, useActualCounts = true, tempCounts = null) {
            // Fetches team data, handling temporary counts for simulation
            const team = teams[teamId];
            if (!team) return null;

            const nameElement = document.getElementById(team.nameId);
            const name = nameElement ? nameElement.value.trim() || team.label : team.label;

            if (team.countId) {
                let count;
                const countElement = document.getElementById(team.countId);
                if (useActualCounts) {
                    count = countElement ? parseInt(countElement.value) || 0 : 0;
                } else if (tempCounts && tempCounts[teamId] !== undefined) {
                    count = tempCounts[teamId];
                } else {
                    // Fallback to actual count if not in tempCounts
                    count = countElement ? parseInt(countElement.value) || 0 : 0;
                }
                return { ...team, id: teamId, name, count };
            } else {
                 return { ...team, id: teamId, name };
            }
        }

        function displayResult(htmlContent) {
            // Updates the output div with results
            const outputDiv = document.getElementById('output');
             outputDiv.innerHTML = htmlContent;
             outputDiv.style.justifyContent = 'center';
             outputDiv.style.textAlign = 'center';
             if (htmlContent.includes('<ol>')) {
                 outputDiv.style.justifyContent = 'flex-start';
                 outputDiv.style.alignItems = 'flex-start';
             } else {
                  outputDiv.style.alignItems = 'center';
             }
        }

         function handleTimeChange() {
            // Reset drip tracker when time changes, as the primary recipient changes
            console.log("Time changed, resetting drip tracker.");
            lastDripAssignment = { gm: -1, tele: -1 };
            // Optional: Clear the results when time context changes
            displayResult("Time context changed. Enter counts and click a button.");
        }

        // Function to check if all members in a list are at a specific cap level
        function areAllAtCap(teamIdList, capLevel, tempCounts) {
            for (const teamId of teamIdList) {
                const teamInfo = getTeamInfo(teamId, false, tempCounts);
                if (!teamInfo || teamInfo.count < capLevel) {
                    return false; // Found someone below the cap level
                }
            }
            return true; // Everyone is at or above the cap level
        }


        // --- Core Logic Functions ---

        function findNextAdmissions(serviceType) {
            console.log(`Finding admissions for ${serviceType}. Initial tracker:`, JSON.stringify(lastDripAssignment));
            // --- Setup based on Service and Time ---
            const timeContext = document.querySelector('input[name="time-context"]:checked').value;
            const isBefore1PM = timeContext === 'before';
            const serviceName = (serviceType === 'gm') ? 'General Medicine' : 'Telemetry';
            const increasesCapKey = (serviceType === 'gm') ? 'increasesCapGM' : 'increasesCapTele';

            let primaryRecipientId;
            let dripOrder;
            if (serviceType === 'gm') {
                primaryRecipientId = isBefore1PM ? 'gm_postcall' : 'gm_oncall';
                dripOrder = genMedDripOrder;
            } else { // tele
                primaryRecipientId = isBefore1PM ? 'tele_postcall' : 'tele_oncall';
                dripOrder = teleDripOrder;
            }
            const timeDisplayText = `Context: ${isBefore1PM ? 'Before 1 PM' : '1 PM or Later'}`;

            // --- Initialize Temporary Counts ---
            let tempCounts = {};
            const allTeamIds = Object.keys(teams); // Get all defined team IDs
            allTeamIds.forEach(teamId => {
                 const teamInfo = getTeamInfo(teamId, true); // Get actual count
                 if (teamInfo && teamInfo.countId) {
                     tempCounts[teamId] = teamInfo.count;
                 }
            });

            // --- Simulation Loop ---
            let nextAdmissionsList = [];
            let allCappedAtBase = false; // Track if everyone hit base cap
            let allCappedAt9 = false; // Track if eligible hit 9
            let allCappedAt10 = false; // Track if eligible hit 10

            // Get the correct starting index for the drip for this calculation run
            let currentDripIndex = lastDripAssignment[serviceType];

            for (let i = 0; i < 7; i++) { // Simulate finding next 7 admissions
                let admissionAssignedThisIteration = false;
                let assignedTo = null; // Track who got the admission

                // 1. Check Primary Recipient (Post-Call or On-Call)
                const primaryInfo = getTeamInfo(primaryRecipientId, false, tempCounts);
                if (primaryInfo && primaryInfo.count < primaryInfo.cap) {
                    assignedTo = primaryRecipientId;
                    nextAdmissionsList.push({
                        name: primaryInfo.name,
                        countAfter: tempCounts[primaryRecipientId] + 1,
                        capInfo: `(Primary - Base Cap: ${primaryInfo.cap})`
                    });
                    tempCounts[primaryRecipientId]++;
                    admissionAssignedThisIteration = true;
                    // Drip index does NOT change when primary receives
                }

                // 2. If Primary is capped OR admission not assigned yet, try the Round-Robin Drip (Base Cap)
                if (!admissionAssignedThisIteration) {
                    let initialDripIndex = currentDripIndex; // Store starting point for this check
                    for (let j = 0; j < dripOrder.length; j++) {
                        let checkIndex = (initialDripIndex + 1 + j) % dripOrder.length; // Start checking *after* last assignment
                        const currentDripTeamId = dripOrder[checkIndex];
                        const teamInfo = getTeamInfo(currentDripTeamId, false, tempCounts);

                        if (!teamInfo || teamInfo.count === undefined) continue;

                        if (teamInfo.count < teamInfo.cap) {
                            assignedTo = currentDripTeamId;
                            nextAdmissionsList.push({
                                name: teamInfo.name,
                                countAfter: tempCounts[currentDripTeamId] + 1,
                                capInfo: `(Drip - Base Cap: ${teamInfo.cap})`
                            });
                            tempCounts[currentDripTeamId]++;
                            currentDripIndex = checkIndex; // Update the index to the person who received
                            admissionAssignedThisIteration = true;
                            break; // Exit the inner loop (for j)
                        }
                    }
                }

                // 3. Check if everyone (primary + drip) is at base cap to enable increase checks
                if (!admissionAssignedThisIteration) {
                     const teamsToCheckBase = [primaryRecipientId, ...dripOrder];
                     allCappedAtBase = areAllAtCap(teamsToCheckBase, teams[primaryRecipientId].cap, tempCounts); // Check base cap (usually 8, 3 for NCT)

                     // Check Cap Increase to 9 (ONLY if all are at base cap)
                     if (allCappedAtBase) {
                         let initialDripIndex = currentDripIndex;
                         for (let j = 0; j < dripOrder.length; j++) {
                             let checkIndex = (initialDripIndex + 1 + j) % dripOrder.length;
                             const currentDripTeamId = dripOrder[checkIndex];
                             const teamInfo = getTeamInfo(currentDripTeamId, false, tempCounts);

                             if (!teamInfo || teamInfo.count === undefined) continue;

                             // Check eligibility for increase AND count < 9
                             if (teamInfo[increasesCapKey] && teamInfo.count < 9) {
                                 assignedTo = currentDripTeamId;
                                 nextAdmissionsList.push({
                                     name: teamInfo.name,
                                     countAfter: tempCounts[currentDripTeamId] + 1,
                                     capInfo: `(Drip - Increased Cap: 9)`
                                 });
                                 tempCounts[currentDripTeamId]++;
                                 currentDripIndex = checkIndex;
                                 admissionAssignedThisIteration = true;
                                 break; // Exit inner loop (for j)
                             }
                         }
                     }
                 }


                // 4. Check if everyone eligible is at cap 9 to enable increase to 10
                 if (!admissionAssignedThisIteration && allCappedAtBase) {
                     const teamsEligibleForIncrease = dripOrder.filter(id => teams[id][increasesCapKey]);
                     // Also include primary if eligible (PostCall GM only)
                     if (teams[primaryRecipientId][increasesCapKey]) {
                         teamsEligibleForIncrease.push(primaryRecipientId);
                     }
                     allCappedAt9 = areAllAtCap(teamsEligibleForIncrease, 9, tempCounts);

                     // Check Cap Increase to 10 (ONLY if all eligible are at 9)
                     if (allCappedAt9) {
                          let initialDripIndex = currentDripIndex;
                         for (let j = 0; j < dripOrder.length; j++) {
                             let checkIndex = (initialDripIndex + 1 + j) % dripOrder.length;
                             const currentDripTeamId = dripOrder[checkIndex];
                             const teamInfo = getTeamInfo(currentDripTeamId, false, tempCounts);

                             if (!teamInfo || teamInfo.count === undefined) continue;

                              // Check eligibility for increase AND count < 10
                             if (teamInfo[increasesCapKey] && teamInfo.count < 10) {
                                 assignedTo = currentDripTeamId;
                                 nextAdmissionsList.push({
                                     name: teamInfo.name,
                                     countAfter: tempCounts[currentDripTeamId] + 1,
                                     capInfo: `(Drip - Increased Cap: 10)`
                                 });
                                 tempCounts[currentDripTeamId]++;
                                 currentDripIndex = checkIndex;
                                 admissionAssignedThisIteration = true;
                                 break; // Exit inner loop (for j)
                             }
                         }
                     }
                 }


                // 5. If no admission was assigned after all checks
                if (!admissionAssignedThisIteration) {
                    allCappedAt10 = true; // Assuming if we got here, all are capped at highest potential
                    break; // Exit the outer loop (for i < 7)
                }

            } // End for i < 7

            // --- Update the persistent drip tracker ---
            lastDripAssignment[serviceType] = currentDripIndex;
            console.log(`Finished ${serviceType}. Final tracker:`, JSON.stringify(lastDripAssignment));


            // --- Display the results ---
            let outputHtml = `<span class="time-context-display">${timeDisplayText}</span>`;

            if (nextAdmissionsList.length > 0) {
                outputHtml += `<p style="text-align: center; width: 100%;">Next ${nextAdmissionsList.length} ${serviceName} Admissions:</p><ol>`;
                nextAdmissionsList.forEach((admission) => {
                    outputHtml += `<li><strong>${admission.name}</strong> (Will have: ${admission.countAfter} patients) <span class="cap-detail">${admission.capInfo}</span></li>`;
                });
                outputHtml += `</ol>`;
            } else {
                 outputHtml += `<p>No available ${serviceName} admission slots found based on current counts for the drip sequence (${isBefore1PM ? 'Before 1 PM' : '1 PM or Later'}).</p>`;
            }

            if (allCappedAt10 || (allCappedAt9 && !teamsEligibleForIncrease.some(id => teams[id].cap < 10)) || (allCappedAtBase && !teamsEligibleForIncrease.length > 0) ) { // Simplified check if fully capped
                 outputHtml += `<p class="all-capped-message"><strong>All teams in the ${serviceName} drip sequence (${isBefore1PM ? 'Before 1 PM' : '1 PM or Later'}) are CAPPED</strong> according to the rules (including potential cap increases). No further admissions possible in this sequence.</p>`;
            }


            displayResult(outputHtml);
        }

        function findNextFlexAdmission() {
            // Logic remains the same: assign to the flex resident with the lower count below cap 8
            const flexRes1Info = getTeamInfo('flex_res_1', true);
            const flexRes2Info = getTeamInfo('flex_res_2', true);

            if (!flexRes1Info || !flexRes2Info) {
                displayResult("Error: Could not retrieve Flex Resident information.");
                return;
            }

            const res1Count = flexRes1Info.count;
            const res2Count = flexRes2Info.count;
            const res1Cap = flexRes1Info.cap;
            const res2Cap = flexRes2Info.cap;

            let nextRes = null;

            if (res1Count < res1Cap && (res1Count <= res2Count || res2Count >= res2Cap)) {
                nextRes = flexRes1Info;
            } else if (res2Count < res2Cap) {
                nextRes = flexRes2Info;
            }

            if (nextRes) {
                 displayResult(`Next Flex/OBS patient goes to: <strong>${nextRes.name}</strong> (Current: ${nextRes.count}, Cap: ${nextRes.cap})`);
            } else {
                 displayResult(`<p class="all-capped-message"><strong>Both Flex Residents are CAPPED</strong> at ${res1Cap}.</p>`);
            }
        }


        function resetCounts() {
            // Resets all counts and names, and the drip tracker
            for (const teamId in teams) {
                const team = teams[teamId];
                 const countElement = document.getElementById(team.countId);
                 if (countElement) {
                     countElement.value = 0;
                 }
                 const nameElement = document.getElementById(team.nameId);
                  if (nameElement && nameElement.type === 'text') {
                      nameElement.value = '';
                  }
            }
            document.getElementById('time-before-1pm').checked = true; // Reset time
            lastDripAssignment = { gm: -1, tele: -1 }; // Reset drip tracker
            displayResult("All counts and names reset. Select time context and enter counts.");
        }

        // --- Event Listeners & Initial Setup ---
        // Add listener to reset drip tracker if time context changes
        document.querySelectorAll('input[name="time-context"]').forEach(radio => {
            radio.addEventListener('change', handleTimeChange);
        });

        // Initial setup
        displayResult("Select the current time context, enter counts, and click a button to find the next admission(s).");

    </script>

</body>
</html>
