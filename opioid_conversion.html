<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Opioid Conversion Calculator</title>
    <!-- Include Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Add custom styles or overrides here if needed */
        /* Style for number input arrows (optional hide) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }
        /* Subtle bg for editable result inputs */
        .result-input {
            background-color: #f8fafc; /* Slightly off-white */
            border: 1px solid #e2e8f0; /* Light border */
             transition: background-color 0.2s ease, border-color 0.2s ease;
        }
         .result-input:focus {
             background-color: white;
             border-color: #3b82f6; /* Blue-500 */
             outline: none; /* Remove default focus outline */
             box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); /* Ring effect */
         }
    </style>
</head>
<body class="bg-slate-100 p-4">

    <div class="max-w-4xl mx-auto bg-gradient-to-b from-white to-slate-50 p-6 md:p-8 rounded-xl shadow-xl border border-slate-200">
        <h1 class="text-3xl font-bold text-slate-800 mb-2 text-center">Interactive Opioid Conversion Calculator</h1>
        <p class="text-base text-slate-600 mb-8 text-center">Select starting opioid and dose to calculate approximate equivalents. Results can be edited to recalculate. (Based on BNF Aug 2020)</p>

        <form id="opioidForm" class="space-y-6">

            <fieldset class="border border-slate-200 p-5 rounded-lg shadow-sm bg-white">
                <legend class="text-lg font-semibold text-slate-800 px-2 -ml-2">Starting Opioid Information</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mt-3">
                    <div>
                        <label for="from_opioid" class="block text-sm font-medium text-slate-700 mb-1">Convert From:</label>
                        <select id="from_opioid" name="from_opioid" required class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 sm:text-sm p-2.5 bg-white text-slate-900">
                            <option value="">-- Select Opioid --</option>
                            <option value="codeine_oral">Codeine (Oral)</option>
                            <option value="dihydrocodeine_oral">Dihydrocodeine (Oral)</option>
                            <option value="hydromorphone_oral">Hydromorphone (Oral)</option>
                            <option value="methadone_oral">Methadone (Oral) - WARNING</option>
                            <option value="morphine_oral">Morphine (Oral)</option>
                            <option value="oxycodone_oral">Oxycodone (Oral)</option>
                            <option value="tapentadol_oral">Tapentadol (Oral)</option>
                            <option value="tramadol_oral">Tramadol (Oral)</option>
                            <option value="buprenorphine_weekly">Buprenorphine Patch (Weekly)</option>
                            <option value="buprenorphine_twice_weekly">Buprenorphine Patch (Twice Weekly)</option>
                            <option value="fentanyl_patch">Fentanyl Patch</option>
                        </select>
                    </div>
                    <div>
                        <label for="from_dose" class="block text-sm font-medium text-slate-700 mb-1">Current Dose:</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="from_dose" name="from_dose" required min="0" step="any" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 sm:text-sm p-2.5 bg-white text-slate-900">
                            <span id="dose_unit_label" class="ml-2 text-sm text-slate-600 whitespace-nowrap">(Unit)</span>
                        </div>
                    </div>
                </div>
                 <p class="text-xs text-slate-500 mt-3">Enter <strong>total dose per 24 hours</strong> for oral meds, or <strong>patch strength</strong> for transdermal.</p>
            </fieldset>

            <!-- Button Container Box -->
            <div class="mt-8 pt-6 pb-4 px-4 bg-slate-50 border border-slate-200 rounded-lg shadow-sm">
                <div class="flex justify-center space-x-4">
                    <button type="button" id="calculateBtn" class="px-6 py-2.5 text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500">
                        Calculate Equivalents
                    </button>
                    <button type="reset" id="resetBtn" class="px-6 py-2.5 text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed bg-slate-200 text-slate-800 hover:bg-slate-300 focus:ring-slate-400">
                        Reset
                    </button>
                </div>
            </div>
            <!-- End Button Container Box -->

        </form>

        <!-- Results Area -->
        <div id="results" class="mt-8 p-6 bg-blue-50 border border-blue-300 rounded-lg shadow-md space-y-4" style="display: none;">
            <div>
                <p class="text-sm font-medium text-blue-800 uppercase tracking-wider">Calculated Basis:</p>
                <p class="text-base text-blue-700">Oral Morphine Equivalent Daily Dose (OMEDD): <strong id="omedd_value">[OMEDD]</strong> mg</p>
            </div>

            <div id="methadone_warning" class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-100 border border-red-300" role="alert" style="display: none;">
              <span class="font-medium">Methadone Conversion Warning!</span> Conversions involving Methadone are complex and variable, requiring specialist knowledge. <strong>This tool cannot provide safe Methadone conversions. Consult specialist advice.</strong> Results below exclude Methadone.
            </div>

             <div>
                 <p class="text-sm font-medium text-blue-800 uppercase tracking-wider mb-2">Approximate Equivalent Doses:</p>
                 <p class="text-xs text-slate-600 mb-3">Values below are editable. Changing a dose will recalculate others based on that new value.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-700 border-collapse border border-slate-300">
                         <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                             <tr>
                                 <th scope="col" class="px-4 py-3 border border-slate-300">Opioid</th>
                                 <th scope="col" class="px-4 py-3 border border-slate-300 text-right">Equivalent Dose</th>
                                 <th scope="col" class="px-4 py-3 border border-slate-300">Unit</th>
                             </tr>
                         </thead>
                         <tbody id="results_table_body">
                             <!-- Results will be populated here -->
                             <!-- Example Row Structure (Generated by JS):
                             <tr>
                                 <td class="px-4 py-2 border border-slate-300 font-medium">Oxycodone (Oral)</td>
                                 <td class="px-4 py-2 border border-slate-300">
                                     <input type="number" value="6.7" step="any" min="0" data-opioid-key="oxycodone_oral" class="w-full text-right p-1 border-none focus:ring-1 focus:ring-blue-500 rounded result-input">
                                 </td>
                                 <td class="px-4 py-2 border border-slate-300">mg/day</td>
                             </tr>
                             -->
                         </tbody>
                     </table>
                 </div>
             </div>

             <p class="mt-5 text-xs text-slate-600 leading-relaxed">
                <strong>Important:</strong> These are *approximate* calculations. Individual response varies. Always reduce calculated dose (e.g., 25-50%) when switching due to incomplete cross-tolerance, and titrate carefully. Refer to current guidelines.
            </p>

             <p class="mt-5 text-xs text-red-600 border-t border-slate-200 pt-3 font-semibold">
                <strong>Disclaimer:</strong> This tool provides approximate opioid dose conversions for informational and educational purposes ONLY. It is NOT a substitute for professional clinical judgment, patient assessment, or local guidelines. Dosing decisions must be individualized by a qualified healthcare provider. Significant inter-individual variability exists. Conversions involving methadone require specialist input. Calculation errors are possible. Use with caution.
            </p>
        </div>
        <!-- End Results Area -->

    </div>

    <script>
        // --- Opioid Data Store ---
        const opioids = {
            'codeine_oral': { name: 'Codeine (Oral)', type: 'oral', unit: 'mg/day', potencyFactor: 0.1 },
            'dihydrocodeine_oral': { name: 'Dihydrocodeine (Oral)', type: 'oral', unit: 'mg/day', potencyFactor: 0.1 },
            'hydromorphone_oral': { name: 'Hydromorphone (Oral)', type: 'oral', unit: 'mg/day', potencyFactor: 5 },
            'methadone_oral': { name: 'Methadone (Oral)', type: 'special', unit: 'mg/day', potencyFactor: NaN },
            'morphine_oral': { name: 'Morphine (Oral)', type: 'oral', unit: 'mg/day', potencyFactor: 1 },
            'oxycodone_oral': { name: 'Oxycodone (Oral)', type: 'oral', unit: 'mg/day', potencyFactor: 1.5 },
            'tapentadol_oral': { name: 'Tapentadol (Oral)', type: 'oral', unit: 'mg/day', potencyFactor: 0.4 },
            'tramadol_oral': { name: 'Tramadol (Oral)', type: 'oral', unit: 'mg/day', potencyFactor: 0.1 },
            'buprenorphine_weekly': {
                name: 'Buprenorphine Patch (Weekly)', type: 'transdermal', unit: 'mcg/hr',
                conversionTable: { 5: 12, 10: 24, 20: 48 },
                reverseTable: { 12: 5, 24: 10, 48: 20 }
            },
            'buprenorphine_twice_weekly': {
                name: 'Buprenorphine Patch (Twice Weekly)', type: 'transdermal', unit: 'mcg/hr',
                conversionTable: { 35: 84, 52: 126, 70: 168 },
                reverseTable: { 84: 35, 126: 52, 168: 70 }
            },
            'fentanyl_patch': {
                name: 'Fentanyl Patch', type: 'transdermal', unit: 'mcg/hr',
                conversionTable: { 12: 30, 25: 60, 50: 120, 75: 180, 100: 240 },
                 // Fentanyl factor approx 2.4 mg/day OMEDD per mcg/hr
                reverseFactor: 2.4, // Use factor for reverse calculation if needed
                reverseTable: { 30: 12, 60: 25, 120: 50, 180: 75, 240: 100 }
            }
        };

        // --- DOM Elements ---
        const form = document.getElementById('opioidForm');
        const fromOpioidSelect = document.getElementById('from_opioid');
        const fromDoseInput = document.getElementById('from_dose');
        const doseUnitLabel = document.getElementById('dose_unit_label');
        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsDiv = document.getElementById('results');
        const omeddValueSpan = document.getElementById('omedd_value');
        const methadoneWarningDiv = document.getElementById('methadone_warning');
        const resultsTableBody = document.getElementById('results_table_body');

        // --- Helper Functions ---
        function isInvalidInput(value) {
            return value === "" || value === null || isNaN(value) || value < 0;
        }

        function round(value, decimals = 1) {
            if (isNaN(value) || !isFinite(value)) return ""; // Return empty string for input value if invalid
            // Avoid rounding extremely small numbers to 0 for display in input
            if (value > 0 && value < Math.pow(10, -decimals)) {
                 return value.toExponential(decimals > 0 ? decimals -1 : 0); // Use scientific notation
            }
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }

         function findClosestLowerKey(table, targetValue) {
             let closestKey = null;
             let foundValue = null;
             const sortedKeys = Object.keys(table).map(Number).sort((a, b) => a - b);
             for (const key of sortedKeys) {
                 if (key <= targetValue) {
                     closestKey = key;
                     foundValue = table[key];
                 } else {
                     break; // Stop once we exceed targetValue
                 }
             }
             return foundValue; // Return the patch strength (value)
         }

        // --- Event Handlers ---
        function updateUnits() {
            const selectedKey = fromOpioidSelect.value;
            if (selectedKey && opioids[selectedKey]) {
                doseUnitLabel.textContent = `(${opioids[selectedKey].unit})`;
                 // Hide methadone warning unless methadone is selected
                methadoneWarningDiv.style.display = (selectedKey === 'methadone_oral') ? 'block' : 'none';
            } else {
                doseUnitLabel.textContent = '(Unit)';
                methadoneWarningDiv.style.display = 'none';
            }
            // Hide results if selection changes after calculation
            if (resultsDiv.style.display !== 'none') {
                resultsDiv.style.display = 'none';
            }
        }

        function resetForm() {
            form.reset();
            resultsDiv.style.display = 'none';
            methadoneWarningDiv.style.display = 'none';
            doseUnitLabel.textContent = '(Unit)';
            resultsTableBody.innerHTML = ''; // Clear table
            // Scroll back to top
            // window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Core Calculation and Display Logic ---
        // Accepts optional params if triggered by editing a result
        function calculateAndDisplay(triggeringOpioidKey = null, triggeringDose = null) {
            let baseOpioidKey = fromOpioidSelect.value;
            let baseDose = parseFloat(fromDoseInput.value);
            let isEditTrigger = false;

            // If triggered by an edit, use that as the base
            if (triggeringOpioidKey !== null && triggeringDose !== null) {
                 if (!isInvalidInput(triggeringDose)) {
                    baseOpioidKey = triggeringOpioidKey;
                    baseDose = triggeringDose;
                    isEditTrigger = true;
                 } else {
                     console.error("Invalid dose from edit trigger.");
                     // Optionally provide feedback to user or revert the invalid edit
                     // For now, just stop recalculation on invalid edit input
                     return;
                 }
            }

            // --- Input Validation (for initial calculation) ---
            if (!isEditTrigger && (!baseOpioidKey || isInvalidInput(baseDose))) {
                alert('Please select an opioid and enter a valid positive dose.');
                resultsDiv.style.display = 'none'; // Ensure results are hidden
                return;
            }

            const baseData = opioids[baseOpioidKey];

            // --- Handle Methadone Selection ---
            if (baseData.type === 'special') {
                methadoneWarningDiv.style.display = 'block';
                omeddValueSpan.textContent = ' N/A ';
                resultsTableBody.innerHTML = '<tr class="text-center text-slate-500"><td colspan="3" class="py-3">Methadone conversions require specialist advice.</td></tr>';
                resultsDiv.style.display = 'block';
                return;
            } else {
                 methadoneWarningDiv.style.display = 'none'; // Hide if not methadone
            }


            // --- Calculate OMEDD (Oral Morphine Equivalent Daily Dose) ---
            let omedd = NaN;
            if (baseData.type === 'oral') {
                omedd = baseDose * baseData.potencyFactor;
            } else if (baseData.type === 'transdermal') {
                if (baseData.conversionTable && baseData.conversionTable[baseDose]) {
                    omedd = baseData.conversionTable[baseDose];
                } else {
                    // Approx for Fentanyl if not exact match
                    if (baseKey === 'fentanyl_patch' && baseData.reverseFactor) {
                         omedd = baseDose * baseData.reverseFactor;
                         console.warn("Fentanyl dose not in table, using approx factor");
                    } else if (baseKey.includes('buprenorphine')) {
                         // Avoid calculation for non-standard Buprenorphine
                         alert(`Dose ${baseDose} ${baseData.unit} is not a standard ${baseData.name} strength. Accurate conversion requires clinical judgment.`);
                         resultsDiv.style.display = 'none'; return;
                    } else { omedd = NaN; }

                    if (isNaN(omedd)) {
                         alert(`Could not calculate OMEDD for ${baseDose} ${baseData.unit} of ${baseData.name}.`);
                         resultsDiv.style.display = 'none'; return;
                    }
                }
            }

            if (isNaN(omedd)) {
                 alert('Error calculating Oral Morphine Equivalent Daily Dose.');
                 resultsDiv.style.display = 'none'; return;
            }

            omeddValueSpan.textContent = ` ${round(omedd, 1)} `;

            // --- Populate Results Table ---
            resultsTableBody.innerHTML = ''; // Clear existing rows
            let calculationErrorOccurred = false;

            for (const targetKey in opioids) {
                 // Skip methadone and the opioid being used as the base for calculation
                if (opioids[targetKey].type === 'special' || targetKey === baseOpioidKey) {
                    continue;
                }

                const targetData = opioids[targetKey];
                let targetDose = NaN;

                if (targetData.type === 'oral') {
                    if (targetData.potencyFactor > 0) {
                        targetDose = omedd / targetData.potencyFactor;
                    } else { targetDose = NaN; } // Avoid division by zero/invalid
                } else if (targetData.type === 'transdermal') {
                     // Use reverse table lookup for standard patches
                     targetDose = findClosestLowerKey(targetData.reverseTable, omedd);
                     if (targetDose === null && targetKey === 'fentanyl_patch' && targetData.reverseFactor && omedd > 0) {
                        // Approx Fentanyl patch if no table match and OMEDD > 0
                        targetDose = round(omedd / targetData.reverseFactor, 0); // Round to nearest whole mcg/hr
                        console.warn(`Approximating Fentanyl patch strength for OMEDD ${omedd}`);
                     } else if (targetDose === null) {
                        targetDose = NaN; // Indicates OMEDD too low or no reverse defined
                     }
                }

                // Create table row
                const tr = document.createElement('tr');
                tr.className = 'bg-white hover:bg-slate-50'; // Add hover effect

                // Opioid Name Cell
                const tdName = document.createElement('td');
                tdName.className = 'px-4 py-2 border border-slate-300 font-medium text-slate-800';
                tdName.textContent = targetData.name;
                tr.appendChild(tdName);

                // Dose Input Cell
                const tdDose = document.createElement('td');
                tdDose.className = 'px-4 py-2 border border-slate-300';

                 const doseInput = document.createElement('input');
                 doseInput.type = 'number';
                 doseInput.step = 'any'; // Allow decimals
                 doseInput.min = '0';
                 doseInput.value = round(targetDose); // Display calculated dose, handle NaN
                 doseInput.dataset.opioidKey = targetKey; // Store key for identification
                 doseInput.className = 'w-full text-right p-1 rounded focus:outline-none result-input';

                if (isNaN(targetDose) || targetDose === null) {
                     doseInput.value = '';
                     doseInput.placeholder = 'N/A'; // Indicate if calculation failed/not applicable
                     doseInput.disabled = true; // Disable input if no valid dose
                     calculationErrorOccurred = !isEditTrigger; // Flag error only on initial calc
                 }

                // Add event listener to handle edits
                 doseInput.addEventListener('input', handleResultEdit);

                 tdDose.appendChild(doseInput);
                 tr.appendChild(tdDose);


                 // Unit Cell
                 const tdUnit = document.createElement('td');
                 tdUnit.className = 'px-4 py-2 border border-slate-300 text-slate-600';
                 tdUnit.textContent = targetData.unit;
                 tr.appendChild(tdUnit);

                 resultsTableBody.appendChild(tr);
            }

             if (calculationErrorOccurred) {
                 console.warn("Some equivalent doses could not be calculated (e.g., OMEDD too low for patches).");
                 // Optionally add a message in the UI
             }


            // --- Show Results ---
            resultsDiv.style.display = 'block';
             // Scroll only on initial calculate button press, not on edits
             if (!isEditTrigger) {
                 resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
             }
        }

        // --- Handler for Edits within the Results Table ---
        function handleResultEdit(event) {
            const editedInput = event.target;
            const opioidKey = editedInput.dataset.opioidKey;
            const newDose = parseFloat(editedInput.value);

            // Check if the input is valid before recalculating
            if (!isInvalidInput(newDose)) {
                 // Recalculate everything based on this edited value
                 // Pass the key and new dose of the *edited* opioid
                 calculateAndDisplay(opioidKey, newDose);
            } else if (editedInput.value === "") {
                // Allow clearing the field, but don't recalculate based on empty
                console.log("Input cleared, no recalculation triggered.");
            } else {
                // Handle invalid input (e.g., negative numbers, text)
                console.error("Invalid dose entered in results table:", editedInput.value);
                 // Optional: Show a temporary error state on the input?
                 // For now, just log error and don't recalculate
            }
        }


        // --- Event Listeners ---
        fromOpioidSelect.addEventListener('change', updateUnits);
        calculateBtn.addEventListener('click', () => calculateAndDisplay()); // Initial calculation
        resetBtn.addEventListener('click', resetForm);

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
             updateUnits(); // Set initial unit label state
        });

    </script>

</body>
</html>
