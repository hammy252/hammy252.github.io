<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Failure GDMT Aid</title>
    <style>
        /* General Styles */
        :root {
            --primary-color: #0056b3; /* A slightly darker blue */
            --secondary-color: #f8f9fa; /* Light grey background */
            --border-color: #dee2e6; /* Lighter border */
            --text-color: #212529; /* Dark grey text */
            --light-text-color: #6c757d; /* Medium grey text */
            --error-color: #dc3545; /* Red for errors/warnings/contraindications */
            --success-color: #198754; /* Green for success/indication */
            --info-bg-color: #eef; /* Light blue/purple for info sections */
            --warning-bg-color: #fff3cd; /* Light yellow for warnings/disclaimers */
            --warning-text-color: #664d03; /* Dark yellow text */
            --warning-border-color: #ffecb5; /* Yellow border */
            --border-radius: 0.375rem; /* Slightly larger radius */
            --box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #e9ecef; /* Slightly off-white page background */
            margin: 0;
            padding: 0;
        }

        /* Main Container */
        .main-container {
            max-width: 900px;
            margin: 2rem auto;
            background-color: #ffffff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden; /* Contain child elements */
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            border-bottom: 5px solid #003f7e; /* Darker blue accent */
        }

        header h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 500;
        }

        /* Content Padding */
        .content-padding {
            padding: 1.5rem 2rem;
        }

        /* Informational Section */
        .info-section {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .info-section h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }

        .info-section h3 {
            color: var(--text-color);
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            font-size: 1.15rem; /* Slightly larger h3 */
            font-weight: 600;
            border-bottom: 1px solid #ddd; /* Subtle underline for h3 */
            padding-bottom: 0.3rem;
        }
         .info-section h4 { /* For sub-sub-headings if needed */
             color: #444;
             margin-top: 1rem;
             margin-bottom: 0.4rem;
             font-size: 1.05rem;
             font-weight: 600;
         }

        .info-section p,
        .info-section ul,
        .info-section ol {
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        .info-section ul,
        .info-section ol {
            padding-left: 1.75rem; /* Consistent padding for lists */
        }
         .info-section ul ul { /* Nested lists */
              margin-top: 0.5rem;
              margin-bottom: 0.5rem;
              padding-left: 1.25rem;
         }
        .info-section li {
            margin-bottom: 0.5rem;
        }
        .info-section strong {
            font-weight: 600;
            color: #000; /* Make strong text black for emphasis */
        }
        .info-section code { /* Style for mnemonics etc. */
            background-color: #e9ecef;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-family: monospace;
        }
         .info-section .hemodynamic-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
         }
         .info-section .hemodynamic-table th,
         .info-section .hemodynamic-table td {
             border: 1px solid var(--border-color);
             padding: 0.5rem 0.75rem;
             text-align: left;
             vertical-align: top;
         }
         .info-section .hemodynamic-table th {
             background-color: #e9ecef;
             font-weight: 600;
         }


        /* Form Styling */
        form {
            margin-bottom: 1.5rem;
        }

        fieldset {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #fff; /* Keep form fields on white */
        }

        legend {
            font-weight: 600;
            font-size: 1.2rem;
            padding: 0 0.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem; /* Add space below legend */
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Adjusted minmax */
            gap: 1.5rem; /* Increased gap */
        }
         .form-group {
             margin-bottom: 0.5rem; /* Add slight space below each group */
         }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group select,
        .form-group input[type="number"] {
            width: 100%;
            padding: 0.75rem; /* Increased padding */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            box-sizing: border-box; /* Include padding in width */
        }
         .form-group input[type="number"]::placeholder {
            color: #aaa;
        }

        .form-group select:focus,
        .form-group input[type="number"]:focus {
            border-color: #86b7fe; /* Blue focus border */
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); /* Blue focus glow */
        }

         /* Checkbox Group Styling */
         .checkbox-group {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive columns */
             gap: 0.75rem 1.5rem; /* Row and column gap */
         }
         .checkbox-group div { /* Container for each checkbox + label */
            display: flex;
            align-items: center; /* Vertically align checkbox and label */
         }
        .checkbox-group label {
            margin-left: 0.5rem; /* Space between checkbox and label text */
            margin-bottom: 0; /* Remove default bottom margin */
            font-weight: normal; /* Normal weight for checkbox labels */
            cursor: pointer; /* Indicate label is clickable */
             flex-grow: 1; /* Allow label to take available space */
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 0; /* Remove default right margin */
            width: 1.15em; /* Slightly larger checkbox */
            height: 1.15em;
            cursor: pointer;
            accent-color: var(--primary-color); /* Style the check color */
             flex-shrink: 0; /* Prevent checkbox from shrinking */
        }

        /* Button Container */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap; /* Allow buttons to wrap on small screens */
        }

        /* Buttons */
        button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            min-width: 150px; /* Ensure buttons have a decent minimum width */
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button:active {
            transform: translateY(0);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        #analyzeBtn { /* Updated ID */
            background-color: var(--primary-color);
            color: white;
        }

        #analyzeBtn:hover {
            background-color: #004080; /* Darker blue on hover */
        }

        #resetBtn {
            background-color: var(--light-text-color);
            color: white;
        }

        #resetBtn:hover {
            background-color: #5a6268; /* Darker grey on hover */
        }

        /* Results Area */
        #results {
            background-color: #fff; /* White background for results section */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
            /* box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); */ /* Subtle inner shadow */
            display: none; /* Hidden by default */
        }

        #results h2 { /* Styling for category headers */
            color: var(--primary-color);
            margin-top: 1.5rem; /* Space above category header */
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            font-size: 1.3rem; /* Slightly smaller than main H2 */
        }
        #results h2:first-of-type { /* Remove top margin for the first category header */
            margin-top: 0;
        }

        /* Summary Sentence Styling */
        #results .summary-sentence {
             font-weight: bold;
             background-color: var(--info-bg-color);
             padding: 1rem;
             border-radius: var(--border-radius);
             border: 1px solid #bdd4ff;
             margin-bottom: 1.5rem; /* Space below summary */
             line-height: 1.5;
         }
         #results .summary-sentence strong {
              color: var(--primary-color);
         }


        /* Individual Result Item Styling */
        .result-item {
            margin-bottom: 1.5rem; /* Space between items */
            padding-bottom: 1rem;
            border-bottom: 1px dashed var(--border-color); /* Dashed separator */
        }
         .result-item:last-child { /* Remove border from last item */
             border-bottom: none;
             margin-bottom: 0;
             padding-bottom: 0;
         }

        .result-item h3 { /* Therapy Name */
            color: #333;
            font-size: 1.15rem;
            margin-top: 0;
            margin-bottom: 0.5rem;
        }

        .result-item p {
            margin-bottom: 0.5rem;
            color: var(--text-color);
            line-height: 1.5;
        }
         .result-item ul { /* Indent list items within results */
             padding-left: 1.5rem;
             margin-top: 0.3rem;
             margin-bottom: 0.5rem;
         }
         .result-item li {
             margin-bottom: 0.3rem;
         }


        .result-item strong { /* Labels like 'Indications:', 'Contraindications:' */
             font-weight: 600;
             display: inline-block; /* Prevent wrapping right after the strong tag */
             margin-right: 0.3em;
        }

        /* Specific Styling for Result Tags */
        .indication { color: var(--success-color); font-weight: 500; }
        .contraindication { color: var(--error-color); font-weight: 500; }
        .reason { /* Reasoning/Context text */
             font-style: italic;
             color: #5a5a5a;
             display: block; /* Ensure reason appears on its own line */
             margin-top: 0.25rem;
             margin-bottom: 0.5rem;
             padding: 0.5rem;
             background-color: #f8f9fa; /* Light background for reasoning */
             border-left: 3px solid var(--primary-color);
             border-radius: 0 4px 4px 0;
        }
        .reason .indication, .reason .contraindication { /* Use colored text within reasoning */
            font-style: normal; /* Override italic */
        }

        /* Highlight Class */
        .highlight { background-color: #fff3cd; padding: 0.2em 0.4em; border-radius: 0.25rem; }

        /* Disclaimer */
        .disclaimer {
            margin: 2rem auto 1rem auto; /* Adjusted margin */
            padding: 1rem;
            font-style: italic;
            color: var(--warning-text-color);
            background-color: var(--warning-bg-color);
            border: 1px solid var(--warning-border-color);
            border-radius: var(--border-radius);
            text-align: center;
            max-width: 850px; /* Match container width better */
            font-size: 0.9rem;
        }
         .disclaimer strong {
             color: #594000;
         }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                width: auto;
            }
            .content-padding {
                padding: 1rem 1.5rem;
            }
            header {
                padding: 1rem 1.5rem;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .form-grid {
                /* grid-template-columns: 1fr; Stack form elements */
                /* Keep auto-fit for better use of space if possible */
            }
            .checkbox-group {
                 /* grid-template-columns: 1fr; */ /* Stack checkboxes */
            }
             .button-container {
                flex-direction: column;
                align-items: center; /* Center buttons when stacked */
             }
             button {
                 width: 90%; /* Make buttons wider when stacked */
                 max-width: 300px; /* But not excessively wide */
             }
        }
         @media (max-width: 480px) {
             body {
                 font-size: 15px; /* Slightly smaller base font on small screens */
             }
              header h1 {
                 font-size: 1.3rem;
             }
              .info-section h2, #results h2 {
                 font-size: 1.25rem;
             }
             legend {
                 font-size: 1.1rem;
             }
             .content-padding {
                 padding: 1rem;
             }
              button {
                 padding: 0.65rem 1rem;
                 font-size: 0.95rem;
                 width: 100%; /* Full width buttons on very small screens */
                 max-width: none;
             }
             .form-grid, .checkbox-group {
                 grid-template-columns: 1fr; /* Force single column */
             }
         }

    </style>
</head>

<body>

    <div class="main-container">
        <header>
            <h1>Heart Failure GDMT Aid</h1>
        </header>

        <div class="content-padding">

            <section class="info-section">
                <h2>Background Information: Heart Failure</h2>

                <h3>Definition</h3>
                <p>Heart failure is a clinical diagnosis. It is a syndrome resulting from structural or functional impairment of ventricular filling or ejection of blood such that the body’s metabolic demands cannot be met. It often involves elevated filling pressures and a propensity to retain volume. An elevated BNP (or NT-proBNP) and TTE showing cardiac dysfunction can be helpful in supporting the diagnosis, but ultimately it is a clinical diagnosis.</p>

                <h3>Classification</h3>
                <p>Most important classification involves dichotomy between preserved (<strong>HFpEF</strong>; EF ≥ 50%) and reduced ejection fraction (<strong>HFrEF</strong>; EF ≤ 40%) phenotypes, as that directs ultimate long-term therapy. HF with mildly reduced EF (<strong>HFmrEF</strong>; EF 41-49%) sits in between.</p>
                <p><strong>NYHA</strong> (New York Heart Association) and <strong>AHA/ACC Stages</strong> are used to classify severity by functional status and stage in progression, respectively.</p>
                <ul>
                    <li><strong>NYHA Class:</strong> I (Asymptomatic), II (Slight limitation), III (Marked limitation), IV (Symptoms at rest).</li>
                    <li><strong>AHA/ACC Stage:</strong> A (At risk), B (Pre-HF), C (Symptomatic HF), D (Advanced HF).</li>
                </ul>

                <h3>Etiologies of Heart Failure and Heart Failure Exacerbations</h3>
                <p><strong>Transthoracic echocardiogram (TTE)</strong> important to establish phenotype (HFrEF vs HFpEF/HFmrEF). Repeat measurement useful in patients with significant change in clinical status.</p>
                <p><strong>Ischemia</strong> is the most common cause of heart failure in US – all patients with new diagnosis of HF should have evaluation for underlying ischemia (noninvasive imaging unless patient presents with angina, VT, or cardiac arrest).</p>
                <h4>Non-ischemic etiologies:</h4>
                <ul>
                    <li>Mechanisms affecting preload/afterload of left heart: chronic HTN, aortic stenosis, aortic regurgitation, mitral regurgitation.</li>
                    <li>Mechanisms affecting rhythm: tachycardia mediated, chronic RV pacing.</li>
                    <li><code>TIMIGS</code> mnemonic for other causes:
                        <ul>
                            <li><strong>Toxin:</strong> EtOH/meth/cocaine, chemotherapy, radiation.</li>
                            <li><strong>Inflammation:</strong>
                                <ul>
                                    <li>Infection: viral myocarditis, Chagas, HIV.</li>
                                    <li>Inflammatory conditions (e.g. SLE).</li>
                                </ul>
                            </li>
                            <li><strong>Metabolic:</strong> thiamine (beri beri) causing high output failure.</li>
                            <li><strong>Infiltrative:</strong> amyloid, hemochromatosis, sarcoid.</li>
                            <li><strong>Genetic.</strong></li>
                            <li><strong>Stress:</strong> Takutsubo, sepsis, peripartum.</li>
                        </ul>
                    </li>
                    <li><strong>HFpEF often associated with:</strong> systemic hypertension, aging, obesity, DM/metabolic syndrome.</li>
                </ul>
                <h4>Etiologies of exacerbations:</h4>
                <p>Cannot miss: <strong>new ischemia</strong> or <strong>new valvular pathology</strong>.</p>
                <p>Others to consider: poor dietary and/or medication adherence, inadequate drug therapy, HTN, arrhythmia (e.g., atrial fibrillation/flutter), medications that increase sodium retention (e.g. NSAIDs, corticosteroids), anemia, AKI, myocarditis/pericarditis, substance use, PE, infection, hyper/hypothyroidism, physical or emotional stress.</p>

                <h3>Evaluation of Acute Heart Failure</h3>
                <p>Review old TTE, stress tests, ECGs, and cath reports.</p>
                <h4>History:</h4>
                <ul>
                    <li>Symptoms: dyspnea, orthopnea, PND, edema, abdominal discomfort/fullness, nausea, anorexia, weight change.</li>
                    <li>Medication history including recent changes and missed doses.</li>
                    <li>Substance history (stimulants and alcohol).</li>
                    <li>Dietary indiscretion.</li>
                </ul>
                <h4>Physical examination:</h4>
                <ul>
                    <li>Evaluate <strong>perfusion (cold vs warm):</strong> altered mental status, Cheyne-Stokes respirations, pallor, cool extremities, narrow pulse pressure.</li>
                    <li>Evaluate for <strong>congestion (wet vs dry):</strong>
                        <ul>
                            <li>Left-sided congestion: crackles (pulmonary edema), left ventricular S3, elevated JVP.</li>
                            <li>Right-sided congestion: elevated JVP, hepato-jugular reflex, dilated and non-collapsible IVC (>2.1 cm, <50% collapsible), pulsatile liver, right ventricular S3, lower extremity edema (poor surrogate for intravascular volume).</li>
                        </ul>
                    </li>
                </ul>
                <h4>Workup for suspected new or worsening HF as cause of dyspnea:</h4>
                <ul>
                    <li>Labs: CBC, chem-10, troponin, BNP, lactate.</li>
                    <li>CXR, EKG, POCUS, TTE.</li>
                    <li>If unknown underlying etiology consider lipid panel, HgbA1c, HIV, UTox, TSH.</li>
                    <li>Evaluation for underlying etiology depends on pre-test probability of ischemia and may include noninvasive stress test, cardiac CT angiography, coronary angiography, or CMR.</li>
                </ul>
                <h4>Causes of falsely high/low BNP:</h4>
                <ul>
                    <li>BNP is <strong>elevated</strong> in advancing age and non-cardiac conditions: anemia, renal failure, PH, critical illness, sepsis.</li>
                    <li>BNP can be <strong>lowered</strong> in obesity, constrictive pericarditis, diuretics, ACE inhibitors, beta-blockers, and MRA.</li>
                    <li>ARNI can cause elevation in BNP (and not NT-proBNP) early after initiation but after 8 weeks has equal prognostic value to NT-proBNP.</li>
                </ul>

                <h3>Management of Acute Heart Failure</h3>
                <p>Therapy should be tailored to the hemodynamic profile as described in the chart below:</p>
                <table class="hemodynamic-table">
                    <thead>
                        <tr><th></th><th>Warm (Well-perfused)</th><th>Cold (Hypoperfusion)</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th>Wet (Congested)</th>
                            <td>Acute care vs TCU<br>IV diuresis<br>Afterload reduction<br>Ok to continue BB if previously on</td>
                            <td>ICU level<br>IV diuresis (ultrafiltration if refractory)<br>Afterload reduction<br>Inotrope or Inodilator<br>Advanced therapies for cardiogenic shock</td>
                        </tr>
                        <tr>
                            <th>Dry (Euvolemic)</th>
                            <td>Outpatient<br>GDMT</td>
                            <td>Afterload reduction (if appropriate)<br>Inotrope or Inodilator (if low output)<br>Advanced therapies for cardiogenic shock<br><em>Careful volume assessment critical</em></td>
                        </tr>
                    </tbody>
                </table>

                <h4>Supportive care:</h4>
                <ul>
                    <li>Telemetry monitoring (with CPO) with supportive O2 (+/- NIPPV) for hypoxemia.</li>
                    <li>Monitor K, Mg, BUN/Cr and replete K>4, Mg>2 daily. Sometimes checked BID during IV diuresis.</li>
                    <li>Restrict sodium (<2g) and also fluids (<1500cc); daily standing weights, strict I&Os.</li>
                    <li>TED hose and lower extremity elevation for swelling.</li>
                    <li>DVT ppx unless contraindicated.</li>
                </ul>

                <h4>Diuretics:</h4>
                <ul>
                    <li>General principles:
                        <ul>
                            <li>Diuretics are threshold drugs – increasing dose above ceiling extends time above natriuretic threshold but does not increase rate of diuresis.</li>
                            <li>Patients experience decreased natriuretic response to subsequent doses of the same diuretic due to extracellular fluid depletion, SNS/RAAS activation, and nephron remodeling.</li>
                            <li>As patients approach euvolemia, rate of diuresis may need to slow to accommodate re-equilibration of extravascular and intravascular fluid compartments.</li>
                        </ul>
                    </li>
                    <li>Start with 2.5 x equivalent home dose (DOSE trial) of loop diuretic. If diuretic naïve, start with 20-40mg IV furosemide.</li>
                    <li>Do not hold diuretics for low BP or initial increase sCr if patient is still intravascularly congested.</li>
                    <li>Double previous dose if poor response.</li>
                    <li>Ensure adequate afterload reduction with ACE/ARB, hydralazine.</li>
                    <li>Loop diuretic equivalencies: 20mg IV furosemide = 40mg PO furosemide = 1mg IV/PO bumetanide = 20mg IV/PO torsemide.</li>
                    <li>Duration of action (dosing interval): Furosemide: 6-8 hours. Bumetanide: 4-6 hours. Torsemide: 12 hours.</li>
                    <li>Diuretic resistance:
                        <ul>
                            <li>Sequential nephron blockade with thiazide (metolazone or chlorothiazide). Metolazone should precede morning loop diuretic by 1 hour.</li>
                            <li>Loop diuretic gtt: give loading dose (bolus) prior to initial dose and when changing rate. Furosemide gtt: initial 20-80mg IV bolus, then start gtt at 5mg/hr (range 5-20mg/hr). Bumetanide gtt: initial 1-2mg bolus, then start gtt at 0.5mg/hr (range 0.2-2mg/hr).</li>
                            <li>Consider low dose dobutamine gtt (improves renal perfusion).</li>
                            <li>Ultrafiltration for patients with obvious volume overload and refractory congestion.</li>
                        </ul>
                    </li>
                    <li>I/O goals depend on clinical volume assessment and cardiac substrate. Aggressive (3-4L neg) vs Conservative (1.5-2L neg).</li>
                    <li>When euvolemic, switch to PO diuretic with goal even to -500ml.</li>
                </ul>

                <h4>Vasodilators:</h4>
                <ul>
                    <li>Not for routine use. May be required for urgent correction of afterload or filling pressures (preload), in non-hypotensive patients (SBP>90).</li>
                    <li>Nitroprusside: Balanced arterial/venous dilation for hypertensive emergency. Requires A-line. Risk of cyanide/thiocyanate toxicity.</li>
                    <li>Nitroglycerin: Predominantly venous dilation for pulmonary congestion/myocardial O2 demand. Avoid with PDE5i. Tachyphylaxis occurs.</li>
                </ul>

                <h4>Inotropes and inodilators:</h4>
                <ul>
                    <li>See section Cardiogenic Shock for details. Requires continuous hemodynamic monitoring.</li>
                    <li>Dobutamine: Common inotrope/inodilator. Side effects: tachycardia, arrhythmia, increased O2 demand.</li>
                    <li>Milrinone: PDE3 inhibitor, longer half-life. Similar side effects.</li>
                </ul>

                <h3>Guideline Directed Medical Therapy (GDMT)</h3>
                 <p>All patients admitted for AHF should be assessed for initiation/titration of GDMT to reduce readmissions and improve long-term outcomes. GDMT should generally be initiated at low doses and slowly up-titrated as tolerated once stable and euvolemic.</p>
                 <h4>HFrEF Foundational Pillars (Mortality Benefit):</h4>
                 <ul>
                     <li><strong>ACE Inhibitors (ACEi) / Angiotensin Receptor Blockers (ARB) / Angiotensin Receptor-Neprilysin Inhibitors (ARNI):</strong> Provide afterload reduction and reduce counterproductive neuro-hormonal adaptations. ARNI (e.g., sacubitril/valsartan) preferred over ACEi/ARB in eligible patients (NYHA II-III/IV). Monitor BP, K+, renal function. <em>ACEi requires 36hr washout before starting ARNI.</em></li>
                     <li><strong>Beta-blockers (Evidence-based):</strong> Metoprolol succinate ER, carvedilol, bisoprolol. Hemodynamic benefits, reduce LV remodeling, decrease arrhythmias. Start low, titrate slowly once euvolemic and stable.</li>
                     <li><strong>Mineralocorticoid Receptor Antagonists (MRA):</strong> Spironolactone, eplerenone. Survival benefit for LVEF ≤35% (or ≤40% post-MI/DM). Monitor K+ and renal function closely (contraindicated if K+ >5.0 or severe renal impairment).</li>
                     <li><strong>SGLT2 Inhibitors:</strong> Dapagliflozin, empagliflozin, etc. Robust mortality/CV benefit in HFrEF (and HFpEF/HFmrEF) regardless of diabetes status. Reduce HF hospitalizations. Monitor for GU infections, volume depletion, euglycemic DKA (rare). Check renal function limits for initiation.</li>
                 </ul>
                 <h4>Other Important Therapies / Considerations:</h4>
                 <ul>
                    <li><strong>Diuretics (Loop/Thiazide):</strong> No mortality benefit, but essential for symptom relief / maintaining euvolemia.</li>
                    <li><strong>Hydralazine + Isosorbide Dinitrate (Hy/ISDN):</strong> Mortality benefit established in self-identified Black patients with NYHA III-IV HFrEF on other GDMT. Also an option for those intolerant to ACEi/ARB/ARNI.</li>
                    <li><strong>Ivabradine:</strong> Reduces HF hospitalizations in HFrEF patients (LVEF ≤35%, NYHA II-III) in sinus rhythm with HR ≥70 bpm despite max tolerated beta-blocker.</li>
                     <li><strong>Vericiguat:</strong> Soluble guanylate cyclase stimulator. Consider in HFrEF (LVEF <45%) after a recent worsening event despite GDMT.</li>
                    <li><strong>Digoxin:</strong> Reduces hospitalizations (no mortality benefit). Consider for persistent symptoms despite GDMT, or for rate control in AFib. Narrow therapeutic window.</li>
                     <li><strong>Iron (IV):</strong> For symptomatic HFrEF/HFmrEF with confirmed iron deficiency (improves symptoms, QOL, reduces hospitalizations).</li>
                    <li><strong>Devices (ICD/CRT):</strong> Considered after ≥3 months of optimal GDMT if LVEF remains ≤35% and other criteria met (NYHA class, QRS duration/morphology). ICD for sudden death prevention, CRT for dyssynchrony.</li>
                    <li><strong>Anticoagulation:</strong> For AFib (based on CHA₂DS₂-VASc) or LV thrombus.</li>
                 </ul>

                <h3>Comorbidities</h3>
                <ul>
                    <li><strong>Atrial fibrillation:</strong> Rate vs rhythm control strategy. Consider catheter ablation (may improve outcomes in HFrEF). Anticoagulation.</li>
                    <li><strong>Sleep disordered breathing:</strong> High prevalence. Evaluate with sleep study if suspected. CPAP if OSA diagnosed.</li>
                    <li><strong>Hypertension:</strong> Target <130/80mmHg. Use GDMT agents first.</li>
                    <li><strong>Anemia:</strong> Evaluate cause. If iron deficiency present in symptomatic HF, consider IV iron repletion.</li>
                </ul>

                 <h3>Palliative Measures / Advanced HF</h3>
                 <ul>
                     <li>Consider for Stage D HF refractory to GDMT. Requires specialist consultation.</li>
                     <li>Options include chronic inotropes (e.g., Milrinone infusions), LVAD, heart transplant evaluation.</li>
                     <li>Focus on symptom control, quality of life, goals of care discussions.</li>
                 </ul>

                <h3>Heart Failure with Preserved Ejection Fraction (HFpEF)</h3>
                <ul>
                    <li>Etiologies/evaluation similar to HFrEF, but ischemia less common. Often linked to HTN, obesity, DM, CKD, AFib.</li>
                    <li>HFpEF Score can help discriminate from non-cardiac dyspnea.</li>
                    <li><strong>Treatment:</strong>
                        <ul>
                            <li>Priority: Treat underlying causes/comorbidities.</li>
                            <li>Mainstay: Diuresis for congestion.</li>
                            <li><strong>Evidence-based therapies:</strong> SGLT2 inhibitors (reduce HF hospitalizations/CV death). MRAs (reduce hospitalizations). ARNIs may be considered.</li>
                            <li>Lifestyle changes crucial (exercise, weight).</li>
                            <li>Other HFrEF GDMT (BB, ACEi/ARB) used primarily for comorbidities (e.g., HTN, CAD).</li>
                        </ul>
                    </li>
                </ul>

                <h3>Discharge Planning</h3>
                <ul>
                    <li>Ensure euvolemia (consider 24h PO diuretics prior).</li>
                    <li>Optimize GDMT as tolerated. Provide clear titration plan.</li>
                    <li>Early follow-up (within 7-10 days).</li>
                    <li>Dietary counseling (Na+/fluid).</li>
                    <li>Weight monitoring instructions (provide scale if needed).</li>
                    <li>Medication reconciliation and adherence discussion.</li>
                </ul>
            </section>

            <form id="gdmtForm">
                <fieldset>
                    <legend>Core Patient Data</legend>
                    <div class="form-grid">
                         <div class="form-group">
                            <label for="age">Age:</label>
                            <input type="number" id="age" name="age">
                        </div>
                        <div class="form-group">
                            <label for="lvef">LVEF (%):</label>
                            <input type="number" id="lvef" name="lvef" placeholder="e.g., 35" required>
                        </div>
                        <div class="form-group">
                            <label for="nyha">NYHA Class:</label>
                            <select id="nyha" name="nyha" required>
                                <option value="">Select NYHA Class</option>
                                <option value="1">I (Asymptomatic)</option>
                                <option value="2">II (Slight limitation)</option>
                                <option value="3">III (Marked limitation)</option>
                                <option value="4">IV (Symptoms at rest)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hr">Heart Rate (bpm) in Sinus Rhythm:</label>
                            <input type="number" id="hr" name="hr" placeholder="Optional, needed for Ivabradine">
                        </div>
                         <div class="form-group">
                            <label for="qrs">QRS Duration (ms) in Sinus Rhythm:</label>
                            <input type="number" id="qrs" name="qrs" placeholder="Optional, needed for CRT">
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Select Applicable Conditions / History</legend>
                    <div class="checkbox-group">
                        <div>
                            <input type="checkbox" id="hasAfib" name="hasAfib">
                            <label for="hasAfib">Atrial Fibrillation (AF)</label>
                        </div>
                        <div>
                            <input type="checkbox" id="hasIronDeficiency" name="hasIronDeficiency">
                            <label for="hasIronDeficiency">Known/Suspected Iron Deficiency</label>
                        </div>
                        <div>
                            <input type="checkbox" id="hasFuncMR" name="hasFuncMR">
                            <label for="hasFuncMR">Significant Functional Mitral Regurgitation (MR)</label>
                        </div>
                        <div>
                            <input type="checkbox" id="isBlack" name="isBlack">
                            <label for="isBlack">Self-Identified Black Race</label>
                        </div>
                        <div>
                            <input type="checkbox" id="hasAngioedemaHx" name="hasAngioedemaHx">
                            <label for="hasAngioedemaHx">History of Angioedema (to ACEi/ARB/ARNI)</label>
                        </div>
                        <div>
                            <input type="checkbox" id="hasSecondaryIcdIndication" name="hasSecondaryIcdIndication">
                            <label for="hasSecondaryIcdIndication">History of Sustained VT/VF or Resuscitated Cardiac Arrest</label>
                        </div>
                        <div>
                            <input type="checkbox" id="hasRecentWorsening" name="hasRecentWorsening">
                            <label for="hasRecentWorsening">Recent Worsening HF Event (Hospitalization or need for IV Diuretics)</label>
                        </div>
                        <div>
                            <input type="checkbox" id="isLbbb" name="isLbbb">
                            <label for="isLbbb">LBBB Morphology (on ECG, relevant for CRT)</label>
                        </div>
                         <div>
                            <input type="checkbox" id="hasDiabetes" name="hasDiabetes">
                            <label for="hasDiabetes">Diabetes Mellitus</label>
                        </div>
                         <div>
                            <input type="checkbox" id="hasCkd" name="hasCkd">
                            <label for="hasCkd">Chronic Kidney Disease (CKD)</label>
                        </div>
                         <div>
                            <input type="checkbox" id="isPostMI" name="isPostMI">
                            <label for="isPostMI">Post-Myocardial Infarction (MI)</label>
                        </div>
                    </div>
                </fieldset>

                <div class="button-container">
                    <button type="button" id="analyzeBtn">Analyze GDMT Options</button>
                    <button type="button" id="resetBtn">Reset</button>
                </div>
            </form>

            <div id="results">
                <!-- Results will be dynamically generated here -->
            </div>

            <div class="disclaimer">
                <strong>Disclaimer:</strong> This tool is for informational and educational purposes only. It provides suggestions based on simplified guideline criteria and is <strong>NOT</strong> a substitute for professional medical advice, diagnosis, treatment, or comprehensive clinical judgment. Therapy selection requires individual patient assessment, including comorbidities, contraindications, tolerability, cost, patient preferences, and expert consultation. Always refer to the latest official clinical practice guidelines.
            </div>

        </div> <!-- End content-padding -->
    </div> <!-- End main-container -->

    <script>
        // DOM Element References (Add new ones as needed)
        const ageInput = document.getElementById('age');
        const lvefInput = document.getElementById('lvef');
        const nyhaSelect = document.getElementById('nyha');
        const hrInput = document.getElementById('hr');
        const qrsInput = document.getElementById('qrs');
        const hasAfibCheck = document.getElementById('hasAfib');
        const hasIronDeficiencyCheck = document.getElementById('hasIronDeficiency');
        const hasFuncMRCheck = document.getElementById('hasFuncMR');
        const isBlackCheck = document.getElementById('isBlack');
        const hasAngioedemaHxCheck = document.getElementById('hasAngioedemaHx');
        const hasSecondaryIcdIndicationCheck = document.getElementById('hasSecondaryIcdIndication');
        const hasRecentWorseningCheck = document.getElementById('hasRecentWorsening');
        const isLbbbCheck = document.getElementById('isLbbb');
        const hasDiabetesCheck = document.getElementById('hasDiabetes'); // Added
        const hasCkdCheck = document.getElementById('hasCkd'); // Added
        const isPostMICheck = document.getElementById('isPostMI'); // Added

        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsDiv = document.getElementById('results');
        const form = document.getElementById('gdmtForm');
        const formInputs = form.querySelectorAll('input, select'); // Get all inputs/selects

        // Helper function to check if a value is not a number or null/empty
        function isNaNOrNull(value) {
            if (value === "" || value === null || typeof value === 'undefined') return true;
            const num = parseInt(value);
            return isNaN(num);
        }

        // --- GDMT Data (Therapies and Rules - adapted from provided code) ---
        const gdmtOptions = [
            // --- Foundational Pillars ---
            {
                name: "ARNI (Sacubitril/Valsartan)",
                category: "Foundational",
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'], // Applicable EF ranges
                indicationRule: (inputs) => (inputs.lvef <= 40 || inputs.lvef <= 50) && inputs.nyha >= 2 && !inputs.hasAngioedemaHx, // PARAGON-HF suggests benefit may extend, strongest for LVEF< normal
                indications: "HFrEF (NYHA II-IV): Preferred first-line RAASi. Reduces morbidity/mortality vs ACEi. HFpEF/HFmrEF (NYHA II-IV): May be considered, esp. LVEF below normal range, to reduce hospitalizations. Can be started de novo or switched from ACEi/ARB (requires 36hr ACEi washout).",
                contraindications: "History of angioedema (ABSOLUTE C/I if prior angioedema to ACEi/ARNI/ARB), concurrent ACEi use (within 36h), pregnancy. Caution: severe renal impairment (check eGFR), hypotension, bilateral RAS.",
                reasoning: (inputs) => inputs.hasAngioedemaHx ? "<span class='contraindication'>Contraindicated due to Angioedema History.</span>" : (inputs.lvef <= 40 ? "<span class='indication'>Preferred RAASi for HFrEF NYHA II-IV.</span>" : (inputs.lvef <= 50 ? "<span class='indication'>Consider for HFmrEF/HFpEF NYHA II-IV.</span>" : ""))
            },
            {
                name: "ACE Inhibitor (ACEi)",
                category: "Foundational",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 40 && !inputs.hasAngioedemaHx, // Standard indication, primarily NYHA II-IV symptomatic benefit, but Class I all LVEF<=40%
                indications: "Alternative if ARNI not tolerated or feasible. Reduces morbidity/mortality in HFrEF (LVEF ≤40%). Start once stable.",
                contraindications: "History of angioedema, bilateral renal artery stenosis, pregnancy, hyperkalemia (K+ >5.5). Caution: renal impairment (monitor Cr/K+), hypotension, cough. Requires 36hr washout before ARNI.",
                reasoning: (inputs) => inputs.hasAngioedemaHx ? "<span class='contraindication'>Contraindicated due to Angioedema History.</span>" : "<span class='indication'>Alternative RAASi if ARNI not used.</span>"
            },
            {
                name: "Angiotensin Receptor Blocker (ARB)",
                category: "Foundational",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 40 && !inputs.hasAngioedemaHx,
                indications: "Alternative if intolerant to ACEi (e.g., cough) and ARNI not feasible/tolerated. Reduces morbidity/mortality in HFrEF (LVEF ≤40%).",
                contraindications: "History of angioedema (use cautiously if only ACEi angioedema, avoid if ARB/ARNI angioedema), bilateral renal artery stenosis, pregnancy, hyperkalemia (K+ >5.5). Caution: renal impairment, hypotension.",
                reasoning: (inputs) => inputs.hasAngioedemaHx ? "<span class='contraindication'>Contraindicated due to Angioedema History (unless specific to ACEi only, discuss risks).</span>" : "<span class='indication'>Alternative RAASi if ACEi/ARNI not used.</span>"
            },
            {
                name: "Consider ARB if ACEi Angioedema", // Special case
                category: "Foundational",
                 appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 40 && inputs.hasAngioedemaHx, // Removed NYHA >= 2 to match ACEi/ARB general indication
                indications: "If angioedema occurred ONLY with an ACEi, an ARB *might* be cautiously considered under specialist supervision, but ARNI remains contraindicated. Discuss risks thoroughly.",
                contraindications: "Prior angioedema to ARB or ARNI or idiopathic angioedema. Pregnancy, bilateral RAS, hyperkalemia.",
                reasoning: (inputs) => "<span class='indication'>Potentially consider ARB (not ARNI) only if angioedema was specific to ACEi and benefits outweigh risks. Requires careful discussion.</span>"
             },
            {
                name: "Beta-Blocker (Evidence-based: Metoprolol Succinate, Carvedilol, Bisoprolol)",
                category: "Foundational",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 40,
                indications: "All patients with HFrEF (LVEF ≤40%), regardless of NYHA class (start once stable/euvolemic). Reduces morbidity/mortality. Titrate to target dose or maximum tolerated dose.",
                contraindications: "Acute decompensated HF (initiate/titrate cautiously once stable), severe bradycardia (<50-55 bpm), high-degree AV block (without pacemaker), cardiogenic shock, severe symptomatic hypotension. Caution: severe asthma/reactive airway disease (use cardioselective like Bisoprolol/Metoprolol cautiously)."
            },
            {
                name: "Mineralocorticoid Receptor Antagonist (MRA - Spironolactone, Eplerenone)",
                category: "Foundational", // Primarily HFrEF foundational, HFpEF add-on
                appliesTo: ['HFrEF', 'HFpEF'],
                indicationRule: (inputs) => (inputs.lvef <= 35 && inputs.nyha >= 2) || (inputs.lvef <= 40 && inputs.isPostMI && (inputs.nyha >= 2 || inputs.hasDiabetes)) || (inputs.lvef >= 45 && inputs.nyha >= 2), // HFrEF + Post-MI + HFpEF criteria
                indications: "HFrEF: LVEF ≤35% & NYHA II-IV (mortality benefit). Post-MI: LVEF ≤40% with HF symptoms or Diabetes. HFpEF: Consider to decrease hospitalizations (TOPCAT subgroup analyses suggest benefit esp. in certain regions/BNP levels). Monitor K+ and renal function (eGFR) closely.",
                contraindications: "Hyperkalemia (K+ > 5.0 mEq/L at baseline), severe renal impairment (e.g., eGFR < 30 mL/min/1.73m² - check specific drug), anuria, Addison's disease. Eplerenone is more selective (less gynecomastia).",
                 reasoning: (inputs) => (inputs.lvef <= 35 && inputs.nyha >= 2) ? "<span class='indication'>Indicated for HFrEF NYHA II-IV (LVEF≤35%).</span>" : ((inputs.lvef <= 40 && inputs.isPostMI && (inputs.nyha >= 2 || inputs.hasDiabetes)) ? "<span class='indication'>Indicated Post-MI with LVEF≤40% and HF/DM.</span>" : (inputs.lvef >= 45 && inputs.nyha >= 2 ? "<span class='indication'>Consider for HFpEF to reduce hospitalizations.</span>" : ""))
            },
            {
                name: "SGLT2 Inhibitor (-gliflozin, e.g., Dapagliflozin, Empagliflozin)",
                category: "Foundational", // Foundational for all HF phenotypes now
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'],
                indicationRule: (inputs) => inputs.lvef >= 1, // Benefit across the spectrum of LVEF
                indications: "Indicated across the spectrum of HF (HFrEF, HFmrEF, HFpEF) regardless of diabetes status. Reduces HF hospitalizations and CV death (most robust in HFrEF). Renal protection benefits.",
                contraindications: "Type 1 Diabetes (risk of DKA), history of DKA, severe renal impairment (check specific eGFR cutoffs for initiation/continuation, typically avoid if eGFR < 20-30). Risk of genital mycotic infections, volume depletion. Monitor for DKA (can be euglycemic).",
                reasoning: (inputs) => "<span class='indication'>Indicated across HF spectrum (HFrEF/HFmrEF/HFpEF) regardless of DM.</span>"
            },
            // --- Symptom Management ---
            {
                name: "Diuretics (Loop: Furosemide, Bumetanide, Torsemide; Thiazide adjunct)",
                category: "Symptom Management",
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'],
                indicationRule: (inputs) => inputs.nyha >= 2, // Driven by symptoms of congestion
                indications: "Management of fluid retention (congestion) in symptomatic HF (NYHA II-IV). Dose adjusted based on symptoms and volume status. IV for acute decompensation. Thiazides (e.g., metolazone) added for diuretic resistance.",
                contraindications: "Anuria. Caution: electrolyte imbalances (hypokalemia, hypomagnesemia), hypotension, severe renal impairment, ototoxicity (high doses/rapid IV). No mortality benefit, purely for symptoms/volume."
            },
             // --- Add-on / Specific Situation Therapies ---
            {
                name: "Ivabradine",
                category: "Add-on",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 35 && (inputs.nyha >= 2 && inputs.nyha <= 3) && !isNaNOrNull(inputs.hr) && inputs.hr >= 70 && !inputs.hasAfib,
                indications: "HFrEF (LVEF ≤35%) in **Sinus Rhythm** with resting HR ≥70 bpm despite maximally tolerated evidence-based beta-blocker dose (or C/I to BB). NYHA II-III. Reduces HF hospitalizations.",
                contraindications: "AFib, Acute decompensated HF, BP <90/50, sick sinus syndrome, SA block, AV block (2nd/3rd degree unless paced), severe hepatic impairment, pacemaker dependence, strong CYP3A4 inhibitors.",
                reasoning: (inputs) => isNaNOrNull(inputs.hr) ? "<span class='contraindication'>(Requires Heart Rate Input)</span>" : (inputs.hasAfib ? "<span class='contraindication'>(Contraindicated in AFib)</span>" : (inputs.hr < 70 ? "<span class='contraindication'>(HR < 70 bpm)</span>" : "<span class='indication'>Consider if HR ≥ 70 bpm in SR despite max BB.</span>"))
            },
            {
                name: "Hydralazine + Isosorbide Dinitrate (Hy/ISDN)",
                category: "Add-on",
                appliesTo: ['HFrEF'],
                 indicationRule: (inputs) => inputs.lvef <= 40 && inputs.nyha >= 3 && inputs.isBlack,
                indications: "Recommended add-on therapy for self-identified Black patients with NYHA Class III-IV HFrEF on optimal foundational therapy (ARNI/ACEi/ARB, BB, MRA, SGLT2i). Reduces morbidity/mortality.",
                contraindications: "Hypersensitivity. Hydralazine: Caution in CAD, lupus-like syndrome. ISDN: Concurrent PDE5 inhibitors (e.g., sildenafil), severe anemia, increased ICP. Both: headache, dizziness, hypotension.",
                 reasoning: (inputs) => inputs.isBlack ? "<span class='indication'>Specific indication for self-identified Black patients with NYHA III-IV HFrEF.</span>" : ""
            },
            {
                name: "Hydralazine + Isosorbide Dinitrate (Hy/ISDN) - Alternative",
                category: "Add-on",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 40 && inputs.nyha >= 2 && (inputs.hasAngioedemaHx || /* Add other potential intolerance reasons here if needed */ false), // Use angioedema Hx or other intolerance marker
                indications: "Can also be considered as an alternative in patients (regardless of race) with HFrEF (esp. NYHA II-IV) who cannot tolerate ACEi/ARB/ARNI due to angioedema, intractable hyperkalemia, or severe renal dysfunction, or remain symptomatic despite other optimal GDMT.",
                contraindications: "Hypersensitivity. Hydralazine: Caution in CAD, lupus-like syndrome. ISDN: Concurrent PDE5 inhibitors, severe anemia, increased ICP. Both: headache, dizziness, hypotension.",
                reasoning: (inputs) => inputs.hasAngioedemaHx ? "<span class='indication'>Consider as alternative RAASi if intolerant (e.g., angioedema hx).</span>" : ""
            },
             {
                name: "Digoxin",
                category: "Add-on",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 40 && inputs.nyha >= 2, // Consider if still symptomatic or AF rate control
                indications: "May be considered to reduce HF hospitalizations (no mortality benefit) in HFrEF patients who remain symptomatic (NYHA II-IV) despite optimal GDMT. Can also aid rate control in AFib (use cautiously). Target low serum levels (e.g., 0.5-0.9 ng/mL).",
                contraindications: "VFib, high-degree AV block (unless paced). Narrow therapeutic window - monitor levels, K+, Mg++, renal function. Many drug interactions. Risk of toxicity increases with hypokalemia, hypomagnesemia, renal dysfunction.",
                reasoning: (inputs) => inputs.hasAfib ? "<span class='indication'>(Also potential option for AF rate control)</span>" : "<span class='indication'>(Consider for symptom/hospitalization reduction)</span>"
            },
            {
                name: "Iron (IV Ferric Carboxymaltose / Derisomaltose)",
                category: "Add-on",
                appliesTo: ['HFrEF', 'HFmrEF'],
                indicationRule: (inputs) => inputs.lvef <= 45 && inputs.nyha >= 2 && inputs.hasIronDeficiency, // Some trials up to EF 50%
                indications: "Symptomatic HFrEF/HFmrEF (LVEF ≤45-50%, NYHA II-IV) and confirmed Iron Deficiency (Ferritin <100 ng/mL, OR Ferritin 100-299 ng/mL with TSAT <20%). Improves symptoms, QOL, exercise capacity, reduces HF hospitalizations. Requires lab confirmation.",
                contraindications: "Known hypersensitivity, iron overload, active infection (relative). Monitor for hypersensitivity reactions during infusion.",
                reasoning: (inputs) => inputs.hasIronDeficiency ? "<span class='indication'>Indicated due to suspected/known Iron Deficiency (confirm with labs: Ferritin & TSAT).</span>" : ""
            },
            {
                name: "Vericiguat",
                category: "Add-on",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef < 45 && inputs.nyha >= 2 && inputs.hasRecentWorsening,
                indications: "Soluble guanylate cyclase stimulator. Consider for patients with symptomatic chronic HFrEF (LVEF <45%) on GDMT who experience a recent worsening HF event (hospitalization or need for outpatient IV diuretics). Reduces composite of CV death or HF hospitalization.",
                contraindications: "Concurrent use of other sGC stimulators or PDE5 inhibitors. Pregnancy. Caution with hypotension, anemia.",
                reasoning: (inputs) => inputs.hasRecentWorsening ? "<span class='indication'>Considered due to recent worsening HF event despite GDMT.</span>" : ""
             },
             {
                name: "Anticoagulation (AC)",
                category: "Add-on",
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'],
                indicationRule: (inputs) => inputs.hasAfib,
                indications: "Indicated for stroke prevention in patients with Atrial Fibrillation (AF) based on CHA₂DS₂-VASc score (typically ≥2 in men, ≥3 in women). Choice between DOAC (preferred) or warfarin. Also indicated for LV thrombus or other embolic source.",
                contraindications: "Active major bleeding, severe thrombocytopenia, recent major surgery/trauma, high bleeding risk outweighing stroke risk (assess with HAS-BLED or similar). Requires assessment of risks/benefits.",
                reasoning: (inputs) => inputs.hasAfib ? "<span class='indication'>Indicated for stroke prevention due to AF (assess CHA₂DS₂-VASc & bleeding risk).</span>" : ""
            },
             // --- Devices ---
             {
                name: "Implantable Cardioverter-Defibrillator (ICD) - Secondary Prevention",
                category: "Device",
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'], // Secondary prevention indication not strictly EF dependent
                indicationRule: (inputs) => inputs.hasSecondaryIcdIndication,
                indications: "Strongly indicated for survivors of cardiac arrest due to VT/VF, or those with spontaneous sustained VT not due to reversible causes, provided meaningful survival >1 year is expected.",
                contraindications: "Terminal illness (<1 year survival), incessant VT/VF, significant psychiatric illness precluding follow-up, patient refusal. Procedure risks.",
                reasoning: (inputs) => inputs.hasSecondaryIcdIndication ? "<span class='indication'>Strong indication due to history of life-threatening arrhythmia/cardiac arrest.</span>" : ""
            },
            {
                name: "Implantable Cardioverter-Defibrillator (ICD) - Primary Prevention",
                category: "Device",
                appliesTo: ['HFrEF'],
                 indicationRule: (inputs) => inputs.lvef <= 35 && (inputs.nyha >= 1 && inputs.nyha <= 3) && !inputs.hasSecondaryIcdIndication && ( (inputs.nyha >=2 && inputs.lvef <= 35) || (inputs.nyha == 1 && inputs.lvef <= 30 && inputs.isPostMI) ), // NYHA I only post-MI LVEF <=30%
                indications: "Consider for Primary Prevention if LVEF ≤35% (NYHA II-III) or LVEF ≤30% (NYHA I post-MI only) despite ≥3 months of optimal GDMT (ischemic/non-ischemic) or ≥40 days post-MI. Must have reasonable expectation of meaningful survival >1 year.",
                contraindications: "Terminal illness (<1 year survival), recent MI (<40d) or revascularization (<3mo, unless bridge therapy used), incessant VT/VF, significant psychiatric illness, patient refusal. Procedure risks.",
                 reasoning: (inputs) => (!inputs.hasSecondaryIcdIndication && inputs.lvef <= 35) ? "<span class='indication'>Consider for primary prevention based on LVEF/NYHA class after ≥3mo GDMT / ≥40d post-MI.</span>" : ""
            },
            {
                name: "Cardiac Resynchronization Therapy (CRT / CRT-D)",
                category: "Device",
                appliesTo: ['HFrEF'],
                indicationRule: (inputs) => inputs.lvef <= 35 && (inputs.nyha >= 2 && inputs.nyha <= 4 && !inputs.hasSecondaryIcdIndication /* Ambulatory IV*/) && !isNaNOrNull(inputs.qrs) && inputs.qrs >= 130 && !inputs.hasAfib, // Check guidelines for specific AFib criteria
                indications: "LVEF ≤35%, Sinus Rhythm, NYHA Class II, III, or ambulatory IV, on optimal GDMT for ≥3 months. Strongest indication with LBBB morphology and QRS ≥150 ms. Consider for LBBB QRS 130-149 ms, or non-LBBB QRS ≥150 ms (less benefit). Improves symptoms, function, reduces hospitalizations, mortality (CRT-D includes ICD).",
                contraindications: "Non-ambulatory NYHA IV, life expectancy <1 year. Benefit less clear/more complex in permanent AFib (requires high % biventricular pacing). Anatomic limitations. Patient refusal.",
                reasoning: (inputs) => isNaNOrNull(inputs.qrs) ? "<span class='contraindication'>(Requires QRS Duration Input)</span>" : (inputs.hasAfib ? "<span class='contraindication'>(Benefit less established/more complex in AFib - check guidelines)</span>" : (inputs.qrs < 130 ? "<span class='contraindication'>(QRS < 130ms)</span>" : (inputs.qrs >= 150 && inputs.isLbbb ? "<span class='indication'>(Strongest indication: LBBB & QRS≥150ms after GDMT trial)</span>" : (inputs.qrs >= 130 && inputs.isLbbb ? "<span class='indication'>(Indicated: LBBB & QRS 130-149ms after GDMT trial)</span>" : (inputs.qrs >= 150 ? "<span class='indication'>(Considered: Non-LBBB & QRS≥150ms after GDMT trial)</span>" : "<span class='contraindication'>(Non-LBBB & QRS 130-149ms - benefit uncertain/not generally recommended)</span>")))))
            },
            // --- Advanced Therapies / Referrals ---
            {
                name: "Mitral Transcatheter Edge-to-Edge Repair (TEER)",
                category: "Advanced / Referral",
                appliesTo: ['HFrEF', 'HFmrEF'], // Primarily studied in HFrEF context
                indicationRule: (inputs) => inputs.lvef >= 20 && inputs.lvef <= 50 && inputs.nyha >= 2 && inputs.hasFuncMR && !inputs.hasRecentWorsening, // COAPT criteria focus
                indications: "Selected patients with chronic severe secondary (functional) Mitral Regurgitation who remain symptomatic (NYHA II-IV ambulatory) despite stable, optimal GDMT (including CRT if indicated), have suitable valve anatomy, and LVESD ≤70mm. Requires heart team evaluation. Reduces hospitalizations/mortality in appropriate candidates (COAPT trial).",
                contraindications: "Unsuitable anatomy, prohibitive LV dilation/dysfunction (LVESD > 70mm), severe RV dysfunction, severe pulmonary hypertension, life expectancy <1 year, primary MR.",
                reasoning: (inputs) => inputs.hasFuncMR ? "<span class='indication'>Consider referral for Heart Team TEER evaluation if severe secondary MR & meets criteria (esp. COAPT-like).</span>" : ""
            },
             {
                name: "Pulmonary Vein Isolation (PVI) Referral for AFib",
                category: "Advanced / Referral",
                appliesTo: ['HFrEF', 'HFmrEF'], // Strongest data in HFrEF
                indicationRule: (inputs) => inputs.hasAfib && inputs.lvef <= 40, // AF + HFrEF
                indications: "Catheter ablation (PVI) should be considered for selected HFrEF patients with symptomatic AFib to improve symptoms and potentially reduce HF hospitalizations/mortality (CASTLE-AF, CABANA subgroups), especially if refractory/intolerant to rate/rhythm control drugs.",
                contraindications: "Prohibitive procedural risk, very enlarged LA, long-standing persistent AFib, patient preference.",
                reasoning: (inputs) => inputs.hasAfib && inputs.lvef <=40 ? "<span class='indication'>Consider referral for EP evaluation re: AF ablation (PVI) due to AFib in HFrEF.</span>" : ""
            },
            {
                name: "Advanced HF Therapies Referral (LVAD / Transplant)",
                category: "Advanced / Referral",
                appliesTo: ['HFrEF'], // Primarily for advanced HFrEF
                indicationRule: (inputs) => inputs.lvef <= 35 && inputs.nyha >= 3 && (inputs.hasRecentWorsening || inputs.nyha == 4), // Proxy for advanced/refractory Stage D
                indications: "Patients with advanced, refractory HFrEF (Stage D) despite optimal medical/device therapy (e.g., persistent NYHA III-IV symptoms, recurrent hospitalizations, end-organ dysfunction due to low output, need for inotropes). Needs evaluation at specialized advanced HF center.",
                contraindications: "Irreversible end-organ damage (renal, hepatic), severe irreversible PHTN, active malignancy, prohibitive comorbidities, active substance abuse, psychosocial issues, non-adherence."
            },
            // --- General & Avoid ---
            {
                name: "Multi-Professional Disease Management Program",
                category: "General / Foundational Care",
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'],
                indicationRule: (inputs) => true, // Essential for all
                indications: "Essential for all HF patients, particularly those with higher symptom burden (NYHA II-IV) or recent hospitalizations. Includes patient education, self-care support (diet, weight monitoring), medication optimization/adherence, coordination of care, addressing psychosocial factors, exercise prescription/cardiac rehab. Improves QOL and reduces readmissions.",
                contraindications: "N/A",
                reasoning: (inputs) => inputs.nyha >= 2 || inputs.hasRecentWorsening ? "<span class='indication'>(Particularly crucial for symptomatic or recently hospitalized patients)</span>" : ""
            },
            {
                name: "Lifestyle & General Measures",
                category: "General / Foundational Care",
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'],
                indicationRule: () => true,
                indications: "Sodium restriction (~<2-3g/day), fluid restriction (~1.5-2L/day if congested/hyponatremic), regular physical activity/cardiac rehab as tolerated, weight management, smoking cessation, limit alcohol, influenza/pneumococcal/COVID-19 vaccination, manage comorbidities (HTN, DM, Afib, Sleep Apnea, Anemia, CKD).",
                contraindications: "N/A"
            },
            {
                name: "Medications to AVOID or Use with Caution",
                category: "Avoid / Caution",
                appliesTo: ['HFrEF', 'HFmrEF', 'HFpEF'],
                indicationRule: () => true,
                indications: "<strong>Avoid:</strong> NSAIDs (inc. COX-2 inhibitors - increase Na/H2O retention, risk of AKI, blunt diuretic/ACEi effect), TZDs (pioglitazone, rosiglitazone - fluid retention), Non-dihydropyridine CCBs (Verapamil, Diltiazem - negative inotropes, AVOID in HFrEF), Class I antiarrhythmics (except amiodarone/dofetilide in select cases), Dronedarone (increased mortality in HF). <strong>Caution:</strong> Pregabalin/Gabapentin (edema), some chemotherapy agents (cardiotoxic), excessive alcohol.",
                contraindications: "N/A"
            }
        ];

        // --- Function to generate the initial summary sentence ---
        function generateSummarySentence(inputs) {
            let sentence = "";
            const isHFrEF = inputs.lvef <= 40;
            const isHFmrEF = inputs.lvef >= 41 && inputs.lvef <= 49;
            const isHFpEF = inputs.lvef >= 50;
            const medicationsToAvoid = "NSAIDs, TZDs, Non-DHP CCBs (in HFrEF)";

            // Core Foundational Therapies based on EF
            let foundational = [];
            if (isHFrEF) {
                foundational.push("ARNI/ACEi/ARB"); // RAASi
                foundational.push("Beta-Blocker"); // BB
                foundational.push("MRA (if LVEF≤35% or Post-MI+DM/HF)"); // MRA
                foundational.push("SGLT2 Inhibitor"); // SGLT2i
            } else if (isHFmrEF) {
                foundational.push("SGLT2 Inhibitor"); // SGLT2i
                 foundational.push("Diuretics (prn symptoms)");
                 foundational.push("Consider ARNI/ARB/MRA (Evidence less robust than HFrEF but often used)");
            } else if (isHFpEF) {
                foundational.push("SGLT2 Inhibitor"); // SGLT2i
                foundational.push("Diuretics (prn symptoms)");
                foundational.push("Manage Comorbidities (HTN, AFib, Obesity, DM)");
                foundational.push("Consider MRA/ARNI (esp. lower EF range/hospitalizations)");
            }

            let efTypeText = isHFrEF ? "HFrEF" : (isHFmrEF ? "HFmrEF" : "HFpEF");
            sentence = `<strong>Summary for ${efTypeText} (LVEF ${inputs.lvef}%):</strong> `;

            if (foundational.length > 0) {
                 sentence += `Prioritize: <strong>${foundational.join(', ')}</strong>. `;
            } else {
                sentence += `Management focuses on symptom control and treating underlying causes/comorbidities. `;
            }

             sentence += `Always avoid: <strong>${medicationsToAvoid}</strong>. `;

            // Add specific notes based on inputs
             if (inputs.hasAngioedemaHx && (isHFrEF || isHFmrEF)) sentence += "<span class='contraindication'>Angioedema Hx contraindicates ARNI/ACEi (consider ARB carefully).</span> ";
             if (inputs.hasAfib) sentence += "Anticoagulation indicated for AFib (assess risk). Consider rate/rhythm control, potential PVI referral in HFrEF/HFmrEF. ";
             if (inputs.hasIronDeficiency && inputs.nyha >=2 && inputs.lvef <= 45) sentence += "Consider IV Iron if confirmed deficient. ";
             if (inputs.hasRecentWorsening && inputs.lvef < 45 && inputs.nyha >= 2) sentence += "Consider Vericiguat. ";
             if (inputs.isBlack && isHFrEF && inputs.nyha >= 3) sentence += "Consider adding Hy/ISDN. ";
             if (inputs.hasSecondaryIcdIndication) sentence += "Secondary prevention ICD strongly indicated. ";
             else if (isHFrEF && inputs.lvef <= 35 && inputs.nyha <= 3) sentence += "Consider primary prevention ICD after ≥3mo GDMT. ";
             if (isHFrEF && inputs.lvef <= 35 && inputs.nyha >= 2 && !isNaNOrNull(inputs.qrs) && inputs.qrs >= 130 && !inputs.hasAfib) sentence += "Consider CRT evaluation after ≥3mo GDMT. ";


            sentence += "Review specific indications/contraindications below.";

            return `<p class="summary-sentence">${sentence}</p>`;
        }

        // --- Form Submission Logic ---
        analyzeBtn.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent potential form submission if type was "submit"

            // Collect inputs
            const inputs = {
                age: parseInt(ageInput.value),
                lvef: parseInt(lvefInput.value),
                nyha: parseInt(nyhaSelect.value),
                hr: parseInt(hrInput.value), // Will be NaN if empty
                qrs: parseInt(qrsInput.value), // Will be NaN if empty
                hasAfib: hasAfibCheck.checked,
                hasIronDeficiency: hasIronDeficiencyCheck.checked,
                hasFuncMR: hasFuncMRCheck.checked,
                isBlack: isBlackCheck.checked,
                hasAngioedemaHx: hasAngioedemaHxCheck.checked,
                hasSecondaryIcdIndication: hasSecondaryIcdIndicationCheck.checked,
                hasRecentWorsening: hasRecentWorseningCheck.checked,
                isLbbb: isLbbbCheck.checked,
                hasDiabetes: hasDiabetesCheck.checked,
                hasCkd: hasCkdCheck.checked,
                isPostMI: isPostMICheck.checked
            };

            // Basic Validation
            if (isNaNOrNull(inputs.lvef) || isNaNOrNull(inputs.nyha)) {
                alert('Please enter LVEF and select NYHA Class.');
                return;
            }

            resultsDiv.innerHTML = ''; // Clear previous results completely
            resultsDiv.style.display = 'none'; // Hide until populated

            // Determine EF Type for filtering
            let efType = 'Unknown';
             if (inputs.lvef <= 40) efType = 'HFrEF';
             else if (inputs.lvef <= 49) efType = 'HFmrEF';
             else if (inputs.lvef >= 50) efType = 'HFpEF';

            // Generate and add the summary sentence FIRST
            resultsDiv.innerHTML += generateSummarySentence(inputs);

            // Filter and display results
            displayResults(inputs, resultsDiv, gdmtOptions, efType);

             // Show results and scroll into view
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        resetBtn.addEventListener('click', resetForm);

        // Hide results if form inputs are changed after interpretation
        formInputs.forEach(input => {
            input.addEventListener('change', () => {
                if (resultsDiv.style.display !== 'none') {
                    resultsDiv.style.display = 'none';
                }
            });
        });


        // Function to display results
        function displayResults(inputs, resultsContainer, options, efType) {
            // Group results by category
            const categories = {
                "Foundational": [],
                "Symptom Management": [],
                "Add-on": [],
                "Device": [],
                "Advanced / Referral": [],
                "General / Foundational Care": [],
                "Avoid / Caution": []
            };

            // Use a Set to avoid duplicate entries if rules overlap significantly
            const addedTherapies = new Set();

            options.forEach(option => {
                 // Skip if therapy doesn't apply to the patient's EF type (unless general/avoid)
                 if (!['General / Foundational Care', 'Avoid / Caution'].includes(option.category) && option.appliesTo && !option.appliesTo.includes(efType)) {
                    return;
                 }

                if ((option.indicationRule(inputs)) && !addedTherapies.has(option.name)) {

                    let contraNotes = ""; // For specific explicit contradictions noted outside main C/I list
                    let reasoningText = option.reasoning ? option.reasoning(inputs) : "";

                    // Special Handling for Angioedema + RAASi
                    if (inputs.hasAngioedemaHx) {
                        if (option.name === "ARNI (Sacubitril/Valsartan)") return; // Skip if history present
                        if (option.name === "ACE Inhibitor (ACEi)") return; // Skip if history present
                        // ARB handling is within the specific "Consider ARB if ACEi Angioedema" rule and ARB contraindications
                    }

                    // Add specific check results to reasoning if not already covered
                     if (option.name === "Ivabradine") {
                         if (isNaNOrNull(inputs.hr)) reasoningText += "<span class='contraindication'>(Requires Heart Rate Input)</span> ";
                         if (inputs.hasAfib) reasoningText += "<span class='contraindication'>(Contraindicated in AFib)</span> ";
                         else if (!isNaNOrNull(inputs.hr) && inputs.hr < 70) reasoningText += "<span class='contraindication'>(HR < 70 bpm)</span> ";
                     }
                     if (option.name === "Cardiac Resynchronization Therapy (CRT / CRT-D)") {
                          if (isNaNOrNull(inputs.qrs)) reasoningText += "<span class='contraindication'>(Requires QRS Duration Input)</span> ";
                          else if (inputs.qrs < 130) reasoningText += "<span class='contraindication'>(QRS < 130ms)</span> ";
                          if (inputs.hasAfib) reasoningText += "<span class='contraindication'>(Benefit less established/more complex in AFib)</span> ";
                     }


                    // Build the HTML string for the result item
                    let displayItem = `
                        <div class="result-item">
                            <h3>${option.name}</h3>
                            ${reasoningText ? `<div class="reason">${reasoningText}</div>` : ''}
                            <p><strong class="indication">Indications:</strong> ${option.indications}</p>
                            <p><strong class="contraindication">Contraindications/Cautions:</strong> ${option.contraindications || 'None specific'}</p>
                            ${contraNotes ? `<p><strong class="contraindication">Note:</strong> ${contraNotes}</p>` : ''}
                        </div>
                    `;

                    // Simpler display for General/Avoid categories
                    if (option.category === 'Avoid / Caution') {
                        displayItem = `
                            <div class="result-item">
                                <h3>${option.name}</h3>
                                <p><strong class="contraindication">Details:</strong> ${option.indications}</p>
                            </div>
                        `;
                    }
                    else if (option.category === 'General / Foundational Care') {
                         displayItem = `
                            <div class="result-item">
                                <h3>${option.name}</h3>
                                ${reasoningText ? `<div class="reason">${reasoningText}</div>` : ''}
                                <p><strong class="indication">Details:</strong> ${option.indications}</p>
                            </div>
                        `;
                    }

                    // Add to the correct category array if the category exists
                    if (categories.hasOwnProperty(option.category)) {
                        categories[option.category].push(displayItem);
                        addedTherapies.add(option.name); // Mark as added
                    }
                }
            });

            // Display grouped results
            let sectionAdded = false; // Track if any sections are added after the summary
            for (const category in categories) {
                if (categories[category].length > 0) {
                    // Create a simple ID for the header
                    const headerId = `category-header-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    // Add category header
                    resultsContainer.innerHTML += `<h2 id="${headerId}">${category}</h2>`;
                    // Add items for the category
                    resultsContainer.innerHTML += categories[category].join('');
                    sectionAdded = true;
                }
            }

            // Handle case where nothing matched beyond summary + general/avoid
             const essentialCategories = ["Foundational", "Symptom Management", "Add-on", "Device", "Advanced / Referral"];
             const essentialDisplayed = essentialCategories.some(cat => categories[cat]?.length > 0);

            if (!sectionAdded) {
                // Nothing displayed at all (shouldn't happen with General/Avoid categories)
                resultsContainer.innerHTML += '<p>No specific therapies matched the selected criteria based on these simplified rules. Review guidelines or check inputs.</p>';
            } else if (!essentialDisplayed && sectionAdded) {
                 // Only General/Avoid categories showed up after the summary
                 // No extra message needed, summary + general/avoid is informative enough
            }
        }


        // --- Reset Form Function ---
        function resetForm() {
            form.reset(); // Resets the form element itself
            resultsDiv.style.display = 'none'; // Hide results
            resultsDiv.innerHTML = ''; // Clear results content
        }

        // Initialize form on load
        resetForm();

    </script>

</body>

</html>
