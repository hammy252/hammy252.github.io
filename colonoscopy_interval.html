<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colonoscopy Interval Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-slate-100; /* Lighter gray background */
        }

        /* --- General Form Styling --- */
        label:not(.checkbox-label):not(.normal-colo-label) { /* Exclude specific checkbox labels */
            @apply block text-sm font-medium text-slate-700 mb-1; /* Slightly darker label text */
        }
        select {
             /* Consistent input styling */
            @apply mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 sm:text-sm p-2.5 bg-white text-slate-900; /* Increased padding slightly */
        }
        input[type="checkbox"] {
             /* Checkbox specific styling */
            @apply h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 focus:ring-offset-0 focus:ring-2; /* Added focus ring offset 0 */
        }
        .checkbox-container {
            /* Container for checkbox and label for better alignment */
            @apply flex items-center h-full; /* Use h-full to align with taller elements */
        }
         .checkbox-label {
            /* Styling for labels next to checkboxes */
            @apply ml-2 text-sm text-slate-800 cursor-pointer; /* Slightly darker label text, pointer cursor */
        }

        /* --- Fieldset Styling --- */
        fieldset {
            @apply border border-slate-200 p-5 rounded-lg shadow-sm bg-white; /* Use slightly rounded lg, white background for contrast */
        }
        legend {
            @apply text-lg font-semibold text-slate-800 px-2 -ml-2; /* Bolder, slightly larger legend, adjust margin */
        }

        /* --- Input Group Alignment --- */
        .input-group {
             /* Wrapper for label + input/select */
             @apply flex flex-col justify-end; /* Align label top, input bottom */
        }
         .fieldset-grid {
            /* Updated grid to handle potentially 3 items */
            @apply grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mt-3; /* Consistent gap */
         }
         .fieldset-grid-other {
             /* Specific grid for 'Other Findings' fieldset */
             @apply grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mt-3;
         }
         .fieldset-grid > div, .fieldset-grid-other > div {
             @apply flex flex-col; /* Ensure children stack vertically */
         }
         /* Specific alignment for checkbox containers in the grid */
         .fieldset-grid .checkbox-container-wrapper, .fieldset-grid-other .checkbox-container-wrapper {
             @apply flex items-end h-full pb-1; /* Align checkbox groups to the bottom matching input fields */
         }
         /* Allow specific items to span columns */
          .md-col-span-2 {
            @apply md:col-span-2;
          }


        /* --- Result Box Styling --- */
        .result-box {
            @apply mt-8 p-6 bg-blue-50 border border-blue-300 rounded-lg shadow-md; /* Softer blue, slightly stronger border */
        }
        .result-title {
            @apply text-md font-semibold text-blue-900; /* Darker blue title */
        }
        .result-interval {
            /* Adjusted size for potentially longer text like "Repeat Colonoscopy..." */
            @apply text-3xl font-bold text-blue-700 mt-1; /* Slightly smaller than 4xl */
        }
        .result-rationale {
             @apply text-sm text-blue-800 mt-3 leading-relaxed; /* Slightly more line spacing */
        }
        .disclaimer {
            @apply mt-5 text-xs text-slate-500 border-t border-slate-200 pt-3; /* Lighter disclaimer text, top border separator */
        }

        /* --- Button Styling --- */
        button {
             /* Base button style */
            @apply px-6 py-2.5 text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-60 disabled:cursor-not-allowed; /* Added disabled styles */
        }
        button#calculate-btn {
             /* Calculate button specific style */
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
        button#reset-btn {
             /* Reset button specific style */
             @apply bg-slate-200 text-slate-800 hover:bg-slate-300 focus:ring-slate-400;
        }

        /* --- Main Container --- */
        .main-container {
             @apply max-w-2xl mx-auto bg-gradient-to-b from-white to-slate-50 p-6 md:p-8 rounded-xl shadow-xl border border-slate-200; /* Subtle gradient, larger radius, border */
        }

         /* --- Title Styling --- */
         .main-title {
            @apply text-3xl font-bold text-slate-800 mb-2 text-center;
         }
         .sub-title {
             @apply text-base text-slate-600 mb-8 text-center; /* Slightly larger subtitle */
         }

         /* --- Normal Colonoscopy Checkbox Specific Styling --- */
         .normal-colo-section {
            /* Added mb-0 because button box now has mt-8 */
            @apply mt-6 p-4 bg-slate-50 border border-slate-200 rounded-md flex items-center shadow-sm mb-0;
         }
         .normal-colo-label {
            @apply ml-3 text-sm font-medium text-slate-800 cursor-pointer;
         }

    </style>
</head>
<body class="p-4 md:p-8">
    <div class="main-container">
        <h1 class="main-title">Colonoscopy Interval Calculator</h1>
        <p class="sub-title">Determine the recommended surveillance interval based on findings from a high-quality colonoscopy.</p>

        <form id="colonoscopy-form" class="space-y-6"> 

            <fieldset>
                <legend>Adenomas</legend>
                <div class="fieldset-grid">
                    <div class="input-group">
                        <label for="num_adenomas">Number of Adenomas:</label>
                        <select id="num_adenomas" name="num_adenomas">
                            <option value="0">0</option>
                            <option value="1-2">1-2</option>
                            <option value="3-4">3-4</option>
                            <option value="5-10">5-10</option>
                            <option value=">10">>10</option>
                        </select>
                    </div>
                    <div class="checkbox-container-wrapper">
                        <div class="checkbox-container">
                             <input type="checkbox" id="adenoma_high_risk" name="adenoma_high_risk">
                             <label for="adenoma_high_risk" class="checkbox-label">Any ≥ 10mm OR Villous/Tubulovillous/HGD?</label>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Sessile Serrated Polyps (SSPs)</legend>
                 <div class="fieldset-grid">
                    <div class="input-group">
                        <label for="num_ssps">Number of SSPs:</label>
                        <select id="num_ssps" name="num_ssps">
                            <option value="0">0</option>
                            <option value="1-2">1-2</option>
                            <option value="3-4">3-4</option>
                            <option value="5-10">5-10</option>
                        </select>
                    </div>
                     <div class="checkbox-container-wrapper">
                         <div class="checkbox-container">
                             <input type="checkbox" id="ssp_high_risk" name="ssp_high_risk">
                             <label for="ssp_high_risk" class="checkbox-label">Any ≥ 10mm OR with Dysplasia?</label>
                         </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Other Findings & Circumstances</legend>
                <div class="fieldset-grid-other">
                    <div class="checkbox-container-wrapper md-col-span-2">
                        <div class="checkbox-container">
                            <input type="checkbox" id="piecemeal_emr_large" name="piecemeal_emr_large">
                            <label for="piecemeal_emr_large" class="checkbox-label font-medium text-red-700">Piecemeal EMR for Polyp > 20mm?</label>
                        </div>
                    </div>
                    <div class="checkbox-container-wrapper">
                        <div class="checkbox-container">
                            <input type="checkbox" id="tsa_present" name="tsa_present">
                            <label for="tsa_present" class="checkbox-label">Traditional Serrated Adenoma (TSA) Present?</label>
                        </div>
                    </div>
                     <div class="checkbox-container-wrapper">
                        <div class="checkbox-container">
                             <input type="checkbox" id="hp_large" name="hp_large">
                             <label for="hp_large" class="checkbox-label">Hyperplastic Polyp (HP) ≥ 10mm Present?</label>
                        </div>
                    </div>
                    <div class="input-group md-col-span-2">
                        <label for="num_hp_small">Number of HPs < 10mm:</label>
                         <select id="num_hp_small" name="num_hp_small">
                            <option value="0">0</option>
                            <option value="1-20">1-20</option>
                            <option value=">20">>20 (Guideline unclear, consult physician)</option>
                        </select>
                    </div>
                </div>
            </fieldset>

             <div class="normal-colo-section">
                <input type="checkbox" id="normal_colo" name="normal_colo">
                <label for="normal_colo" class="normal-colo-label">Was the colonoscopy completely normal (no polyps found)?</label>
             </div>

             <!-- New Button Container Box -->
            <div class="mt-8 pt-6 pb-4 px-4 bg-slate-50 border border-slate-200 rounded-lg shadow-sm">
                <div class="flex justify-center space-x-4">
                    <button type="button" id="calculate-btn">Calculate Interval</button>
                    <button type="reset" id="reset-btn">Reset Form</button>
                </div>
            </div>
            <!-- End New Button Container Box -->

        </form>

        <div id="result" class="result-box" style="display: none;"> 
            <p class="result-title">Recommended Surveillance Interval:</p>
            <p id="interval" class="result-interval"></p>
            <p id="rationale" class="result-rationale"></p>
             <p class="disclaimer">
                <strong>Disclaimer:</strong> This calculator is based on common guideline interpretations (e.g., US Multi-Society Task Force, ASGE). It assumes a high-quality baseline colonoscopy (complete to cecum, adequate prep, adequate ADR, complete polyp resection *unless piecemeal EMR noted*). This tool is for informational purposes only and does not substitute for professional clinical judgment or personalized medical advice. Consult a healthcare professional for decision-making. Intervals may vary based on specific guidelines, clinical context, and individual patient factors.
            </p>
        </div>
    </div>

    <script>
        // Get references to form elements
        const form = document.getElementById('colonoscopy-form');
        const numAdenomasSelect = document.getElementById('num_adenomas');
        const adenomaHighRiskCheckbox = document.getElementById('adenoma_high_risk');
        const numSspsSelect = document.getElementById('num_ssps');
        const sspHighRiskCheckbox = document.getElementById('ssp_high_risk');
        const piecemealEmrLargeCheckbox = document.getElementById('piecemeal_emr_large'); // New element
        const tsaCheckbox = document.getElementById('tsa_present');
        const hpLargeCheckbox = document.getElementById('hp_large');
        const numHpSmallSelect = document.getElementById('num_hp_small');
        const normalColoCheckbox = document.getElementById('normal_colo');
        const calculateBtn = document.getElementById('calculate-btn');
        const resetBtn = document.getElementById('reset-btn');
        const resultDiv = document.getElementById('result');
        const intervalDisplay = document.getElementById('interval');
        const rationaleDisplay = document.getElementById('rationale');

        // --- Calculation Logic (Updated for clearer 6 month text) ---
        function calculateInterval() {
            // Read input values
            const numAdenomas = numAdenomasSelect.value;
            const adenomaHighRisk = adenomaHighRiskCheckbox.checked;
            const numSsps = numSspsSelect.value;
            const sspHighRisk = sspHighRiskCheckbox.checked;
            const piecemealEmrLarge = piecemealEmrLargeCheckbox.checked; // Read new checkbox
            const tsaPresent = tsaCheckbox.checked;
            const hpLarge = hpLargeCheckbox.checked;
            const numHpSmall = numHpSmallSelect.value;
            const isNormal = normalColoCheckbox.checked;

            let interval = '';
            let reason = '';

            // Define if any significant finding exists (including the new checkbox)
            const anyPolypFinding = numAdenomas !== '0' ||
                                    adenomaHighRisk ||
                                    numSsps !== '0' ||
                                    sspHighRisk ||
                                    piecemealEmrLarge || // Include new check
                                    tsaPresent ||
                                    hpLarge ||
                                    numHpSmall !== '0';

             // --- Logic based on risk hierarchy (highest risk/priority first) ---

             // 0. Piecemeal EMR > 20mm (Highest Priority Short-term Follow-up)
             if (piecemealEmrLarge) {
                 interval = 'Repeat Colonoscopy in 6 Months'; // Clearer Text
                 reason = 'Based on piecemeal EMR resection of a polyp > 20mm, requiring short-term follow-up to assess for residual/recurrent polyp.';
             }
             // 1. Normal Colonoscopy (Overrides everything if checked)
             else if (isNormal) {
                 // Check for conflict: Normal checked AND other findings selected
                 if (anyPolypFinding && !piecemealEmrLarge) { // Don't show conflict if only piecemeal EMR was checked (handled above)
                     interval = 'Review Inputs';
                     reason = 'Conflicting input: "Normal Colonoscopy" was checked, but other polyp findings were also entered. Please uncheck "Normal" or clear the other findings.';
                 } else {
                     interval = '10 Years';
                     reason = 'Based on a normal colonoscopy finding (no polyps).';
                 }
             }
             // 2. Highest Risk (>10 Adenomas)
             else if (numAdenomas === '>10') {
                interval = '1 Year';
                reason = 'Based on finding > 10 adenomas.';
            }
             // 3. High Risk (Large polyps, advanced histology, 5-10 polyps, TSA)
            else if (tsaPresent || sspHighRisk || adenomaHighRisk || numAdenomas === '5-10' || numSsps === '5-10') {
                 interval = '3 Years';
                 if (tsaPresent) reason = 'Based on finding a Traditional Serrated Adenoma (TSA).';
                 else if (sspHighRisk) reason = 'Based on finding SSP(s) ≥ 10mm or with dysplasia.';
                 else if (adenomaHighRisk) reason = 'Based on finding adenoma(s) ≥ 10mm or with villous/tubulovillous histology or high-grade dysplasia.';
                 else if (numAdenomas === '5-10') reason = `Based on finding ${numAdenomas} adenomas.`;
                 else if (numSsps === '5-10') reason = `Based on finding ${numSsps} SSPs.`;
                 else reason = 'Based on high-risk findings.'; // Fallback for this category
            }
             // 4. Moderate Risk (Large HP, 3-4 Adenomas/SSPs)
             else if (hpLarge || numAdenomas === '3-4' || numSsps === '3-4') {
                interval = '3-5 Years';
                 if (hpLarge) reason = 'Based on finding Hyperplastic Polyp(s) ≥ 10mm.';
                 else if (numAdenomas === '3-4') reason = `Based on finding ${numAdenomas} adenomas (<10mm, no high-risk features).`;
                 else if (numSsps === '3-4') reason = `Based on finding ${numSsps} SSPs (<10mm, no high-risk features).`;
                 else reason = 'Based on moderate-risk findings.'; // Fallback reason
            }
             // 5. Low-Risk Serrated (1-2 small SSPs)
            else if (numSsps === '1-2') {
                 interval = '5-10 Years';
                 reason = 'Based on finding 1-2 SSPs < 10mm (without dysplasia).';
            }
             // 6. Low-Risk Adenomas (1-2 small adenomas)
            else if (numAdenomas === '1-2') {
                interval = '7-10 Years';
                reason = 'Based on finding 1-2 adenomas < 10mm (without high-risk features).';
            }
             // 7. Low-Risk Hyperplastic Polyps or No Polyps (if 'Normal' wasn't checked but no other findings)
             else if (!anyPolypFinding || (numHpSmall === '1-20' && numAdenomas === '0' && numSsps === '0' && !tsaPresent && !hpLarge && !adenomaHighRisk && !sspHighRisk && !piecemealEmrLarge)) {
                interval = '10 Years';
                if (numHpSmall === '1-20') reason = 'Based on finding only 1-20 hyperplastic polyps < 10mm.';
                else reason = 'Based on no significant findings (equivalent to normal or only minimal, small HPs).';
            }
             // 8. Unclear Guideline (>20 small HPs only)
             else if (numHpSmall === '>20' && numAdenomas === '0' && numSsps === '0' && !tsaPresent && !hpLarge && !adenomaHighRisk && !sspHighRisk && !piecemealEmrLarge) {
                 interval = 'Consult Physician';
                 reason = 'Guideline recommendations may vary for >20 small hyperplastic polyps as the only finding. Clinical correlation and discussion with a physician are recommended.';
            }
             // 9. Catch-all / Error State
            else {
                 interval = 'Review Inputs / Consult Physician';
                 reason = 'Could not determine a clear interval. Please ensure inputs are accurate and not conflicting, or consult guidelines/physician.';
            }

            // Display the result
            intervalDisplay.textContent = interval;
            rationaleDisplay.textContent = reason;
            resultDiv.style.display = 'block'; // Show the result box

            // Scroll to the result smoothly
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- Form Handling Logic ---
        function handleNormalColoCheck() {
            const isChecked = normalColoCheckbox.checked;
            // Select all relevant form inputs *except* the normal checkbox itself
            const formElements = form.querySelectorAll('select, input[type="checkbox"]:not(#normal_colo)');

            formElements.forEach(el => {
                el.disabled = isChecked; // Disable if normal is checked
                if (isChecked) {
                    // Visually indicate disabled state and reset values
                    el.classList.add('opacity-50', 'cursor-not-allowed');
                    if (el.type === 'checkbox') {
                        el.checked = false;
                    } else if (el.tagName === 'SELECT') {
                        el.selectedIndex = 0; // Reset dropdowns
                    }
                } else {
                    // Re-enable if unchecked
                     el.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
             calculateBtn.disabled = false; // Keep calculate button enabled always for now
             // If normal is checked, hide the result box immediately if it was showing
             if (isChecked) {
                 resultDiv.style.display = 'none';
             }
        }

        function resetForm() {
            form.reset(); // Use native form reset
            // Re-enable all elements and remove disabled styling
            const formElements = form.querySelectorAll('select, input[type="checkbox"]');
            formElements.forEach(el => {
                el.disabled = false;
                el.classList.remove('opacity-50', 'cursor-not-allowed');
             });
            // Hide result box
            resultDiv.style.display = 'none';
            intervalDisplay.textContent = '';
            rationaleDisplay.textContent = '';
            calculateBtn.disabled = false; // Ensure calculate button is enabled
            // Scroll back to top smoothly
            // Use try/catch in case element isn't visible/available yet
            try {
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (e) { /* ignore scroll error on initial load */ }
        }

        // --- Event Listeners ---
        calculateBtn.addEventListener('click', calculateInterval);
        resetBtn.addEventListener('click', resetForm);
        normalColoCheckbox.addEventListener('change', handleNormalColoCheck);

        // Add listeners to clear results if form changes after calculation
        form.addEventListener('change', (event) => {
             // Don't hide if the change was checking/unchecking the 'normal' box (handled separately)
             if (event.target !== normalColoCheckbox) {
                  // Hide result box only if it is currently displayed
                  if (resultDiv.style.display !== 'none') {
                     resultDiv.style.display = 'none';
                  }
             }
             // Basic enable/disable logic - keep enabled for now
             calculateBtn.disabled = false;
        });


        // --- Initial Setup ---
        resetForm(); // Initialize form state on load

    </script>

</body>
</html>
